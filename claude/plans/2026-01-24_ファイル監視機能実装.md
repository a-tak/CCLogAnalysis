# ファイルシステム監視機能 実装プラン

## 概要

Claude Codeのログファイル（`.jsonl`）が追加されたときに、自動的にデータベースへ同期する機能を実装します。負荷制御を重視し、環境変数で同期頻度を調整可能にします。

## 実装方針: ポーリング方式（定期スキャン）

### 選定理由

**ポーリング方式を採用**
- Go標準ライブラリのみで実装可能（外部ライブラリ不要）
- 負荷制御が容易（スキャン間隔を環境変数で調整）
- 既存の`db.SyncIncremental()`を定期的に呼び出すだけでシンプル
- テストが容易（時間制御可能）

**fsnotifyを採用しない理由**
- 外部ライブラリの追加が必要
- 大量イベント時のデバウンス実装が複雑化
- プロジェクトの「Go標準ライブラリ優先」方針に合致

## アーキテクチャ

```
cmd/server/main.go
  └─ watcher.Start() 起動
       ↓
internal/watcher/watcher.go
  └─ 定期スキャン（goroutine + time.Ticker）
       ↓
internal/db/sync.go
  └─ SyncIncremental() 呼び出し
       └─ 新規セッションのみDB同期
```

## 環境変数設定

| 変数名 | 説明 | デフォルト値 | 範囲 |
|--------|------|--------------|------|
| `ENABLE_FILE_WATCH` | ファイル監視機能の有効化 | `false` | `true`/`false` |
| `FILE_WATCH_INTERVAL` | スキャン間隔（秒） | `15` | 5～3600 |
| `FILE_WATCH_DEBOUNCE` | デバウンス時間（秒） | `5` | 1～60 |

**デフォルト値の根拠**
- 15秒間隔: 新規セッション検出が早く、CPU負荷も低い（最小5秒まで設定可能）
- 5秒デバウンス: 短時間の連続イベント抑制
- デフォルト無効: 既存動作への影響を最小化（後方互換性）

## 実装ファイル

### 新規作成

1. **`internal/watcher/config.go`** (約80行)
   - 環境変数の読み込みと検証
   - `WatcherConfig`構造体
   - デフォルト値管理

2. **`internal/watcher/config_test.go`** (約150行)
   - 環境変数読み込みのテスト
   - 境界値テスト

3. **`internal/watcher/watcher.go`** (約200行)
   - `FileWatcher`構造体
   - ポーリングループ（goroutine）
   - デバウンス処理
   - graceful shutdown対応

4. **`internal/watcher/watcher_test.go`** (約300行)
   - ポーリング動作のテスト
   - デバウンス機能のテスト
   - Start/Stopのテスト

### 変更が必要なファイル

5. **`cmd/server/main.go`** (約30行追加)
   - ファイルウォッチャー初期化
   - `watcher.Start()`呼び出し
   - graceful shutdown処理（シグナルハンドリング）

6. **`README.md`**
   - 環境変数セクションに新規3変数を追加
   - ファイル監視機能の説明

7. **`CLAUDE.md`** (新規ルール追加)
   - プランファイル命名規則を追加
   - 形式: `YYYY-MM-DD_タスク名.md`（日本語）

## 実装ステップ（TDD）

### Sprint 1: 基盤実装 (2-3時間)

**Red → Green → Refactor**

1. `internal/watcher/config_test.go` 作成（環境変数読み込みテスト）
2. `internal/watcher/config.go` 実装
3. `internal/watcher/watcher_test.go` の基本テスト作成（コンストラクタ、Start/Stop）
4. `internal/watcher/watcher.go` の基本構造実装

**検証**
```bash
go test ./internal/watcher/... -v
```

### Sprint 2: ポーリング・同期機能 (3-4時間)

**Red → Green → Refactor**

1. ポーリング動作のテスト追加（定期実行、同期トリガー）
2. ポーリングループ実装（`watchLoop()`、`time.Ticker`）
3. デバウンス機能のテスト追加
4. デバウンス実装（`shouldSync()`、スレッドセーフ）

**検証**
```bash
go test ./internal/watcher/... -v -run TestWatchLoop
go test ./internal/watcher/... -v -run TestDebounce
```

### Sprint 3: エラーハンドリング・統合 (2-3時間)

**Red → Green → Refactor**

1. エラーハンドリングのテスト追加
2. エラーハンドリング実装（パニック防止、ログ出力）
3. `cmd/server/main.go` 更新（ウォッチャー初期化、graceful shutdown）

**検証**
```bash
# ユニットテスト
go test ./internal/watcher/... -v

# 統合テスト（手動）
ENABLE_FILE_WATCH=true FILE_WATCH_INTERVAL=10 go run ./cmd/server/main.go
# 別ターミナルで新規セッションファイル作成して確認
```

### Sprint 4: ドキュメント・ルール追加 (1-2時間)

1. `README.md` 更新（環境変数、使用例）
2. `CLAUDE.md` にプランファイル命名規則を追加
   - 形式: `claude/plans/YYYY-MM-DD_タスク名.md`
   - 日本語でわかりやすいタスク名を使用
3. WIPドキュメント作成（`docs/WIP/2026-01-24_ファイルシステム監視機能実装.md`）
4. 総合テスト（新規セッション追加、負荷テスト）

## 重要なファイル（実装前に確認）

- **`cmd/server/main.go`** - 起動処理の理解、統合箇所の確認
- **`internal/db/sync.go`** - `SyncIncremental()`の動作確認
- **`internal/db/sync_test.go`** - テストパターンの参考

## テスト戦略

### ユニットテスト

- 環境変数読み込み（デフォルト値、境界値、不正値）
- ウォッチャーライフサイクル（Start/Stop、冪等性）
- ポーリング動作（定期実行、間隔の正確性）
- デバウンス機能（連続イベント抑制、スレッドセーフ性）
- 同期トリガー（`SyncIncremental()`呼び出し確認）

### 統合テスト（手動）

1. **基本動作確認**
   ```bash
   ENABLE_FILE_WATCH=true FILE_WATCH_INTERVAL=15 ./bin/ccloganalysis
   # 新規セッションファイル作成 → 15秒以内にDB同期確認
   ```

2. **デバウンステスト**
   ```bash
   # 短時間に複数ファイル作成 → デバウンス時間後に1回のみ同期実行
   ```

3. **graceful shutdownテスト**
   ```bash
   # サーバー起動 → Ctrl+C → クリーンに終了確認
   ```

## リスク対策

| リスク | 影響 | 対策 |
|--------|------|------|
| ポーリング頻度が高すぎる | CPU負荷上昇 | デフォルト15秒、最小5秒に制限 |
| 大量ファイル追加 | DB負荷 | デバウンス機能、トランザクション処理 |
| ゴルーチンリーク | メモリリーク | `Stop()`で確実に停止、テストで検証 |
| 同期中のシャットダウン | データ不整合 | graceful shutdown、完了待機 |

## 検証方法（実装後）

### 動作確認

```bash
# 1. サーバー起動（監視有効）
ENABLE_FILE_WATCH=true FILE_WATCH_INTERVAL=15 ./bin/ccloganalysis

# 2. 新規セッションファイルを作成
cp test-session.jsonl ~/.claude/projects/test-project/new-session-$(date +%s).jsonl

# 3. ログ確認（15秒以内に同期実行）
# Expected: "File watcher: triggering sync..."
# Expected: "Synced X sessions from Y projects"

# 4. API経由で確認
curl http://localhost:8080/api/sessions | jq '.sessions[] | select(.id | contains("new-session"))'

# 5. graceful shutdown確認
# Ctrl+C → "Shutting down gracefully..." → "File watcher stopped"
```

### 負荷テスト

```bash
# 大量セッション作成（100件）
for i in {1..100}; do
  cp test-session.jsonl ~/.claude/projects/test-project/session-$i.jsonl
done

# Expected: すべてDB同期、メモリリークなし
# パフォーマンス目標: セッション100個で5秒以内
```

## 技術的決定事項

- **ポーリング方式**: Go標準ライブラリのみ、負荷制御が容易
- **デフォルト無効**: 既存動作への影響を最小化
- **`SyncIncremental()`再利用**: 既存の重複チェック機能を活用
- **graceful shutdown**: シグナルハンドリング（SIGINT/SIGTERM）
- **プランファイル命名規則**: `claude/plans/YYYY-MM-DD_タスク名.md`（日本語）

## 合計追加行数（見積もり）

- 新規: 約730行（実装450行 + テスト280行）
- 変更: 約30行（`cmd/server/main.go`）
- ドキュメント: 約70行（`README.md`更新 + `CLAUDE.md`ルール追加）

**合計: 約830行**
