# セッション0件問題の継続調査

**日付**: 2026-01-25
**ブランチ**: `investigate-session-pickup-issue`
**状態**: 診断機能実装済み、根本原因未解決

## 問題の概要

フロントエンドのセッション一覧画面で、セッション数が **0件** と表示される問題が継続しています。

### 背景

- ファイルシステム上には66個のセッションファイル（`.jsonl`）が存在
- データベースには2852個のセッションが同期されている（診断エンドポイントで確認済み）
- しかし、フロントエンドでは0件と表示される

## これまでの作業

### 1. 診断機能の実装（完了）

以下の機能を実装して、問題の診断を可能にしました：

#### 実装したファイル

- `internal/logger/logger.go` - 構造化ログ機能
- `internal/logger/logger_test.go` - ログのテスト
- `internal/api/debug.go` - デバッグエンドポイント
- `internal/api/debug_test.go` - デバッグエンドポイントのテスト
- `internal/db/sync.go` - 詳細ログ追加、UNIQUE制約エラーハンドリング
- `internal/db/sync_test.go` - 同期処理のテスト

#### 診断エンドポイント

```bash
curl http://localhost:8081/api/debug/status
```

**期待される出力例**:
```json
{
  "db_projects": 105,
  "db_sessions": 2852,
  "fs_projects": 105,
  "sync_status": "success",
  "sync_error": ""
}
```

### 2. エラーハンドリング改善（完了）

- `ListSessions` でプロジェクトが見つからない場合、警告ログを出力するように変更
- UNIQUE制約エラーを検出して、重複セッションをスキップ（WARNレベル）
- `SyncResult` にエラー詳細（`Errors []string`）を追加

### 3. mainブランチのマージ（完了）

以下の機能がmainブランチから統合されました：
- Git Root検出機能
- プロジェクトグループ機能
- プロジェクト詳細・グループ詳細ページ
- セッションリストタブ

### 4. サーバー管理スクリプト実装（完了）

- `.claude/skills/server-management/scripts/start-server.sh` - サーバー起動
- `.claude/skills/server-management/scripts/stop-server.sh` - サーバー停止

**現在のサーバー状態**:
- URL: http://localhost:8081
- ログレベル: DEBUG
- 起動中

## 現在の状況

### 確認済みの事実

1. **データベースには正しくデータが入っている**
   - 105プロジェクト
   - 2852セッション

2. **初期同期は成功している**
   - `sync_status: "success"`
   - エラーなし

3. **フロントエンドでセッション一覧を開くと0件**
   - プロジェクト一覧は表示される
   - セッション一覧タブに切り替えても0件

### 未確認の可能性

- **APIリクエストが正しく動作していない可能性**
  - フロントエンドからのAPIリクエストパラメータが間違っている？
  - レスポンスが空配列になっている？

- **フロントエンドのデータ取得ロジックに問題がある可能性**
  - APIクライアントの実装に問題？
  - 状態管理の問題？

- **バックエンドのListSessionsエンドポイントに問題がある可能性**
  - プロジェクト名のフィルタリングが機能していない？
  - レスポンス形式が間違っている？

## 次のステップ

### 1. APIリクエストの確認（最優先）

ブラウザの開発者ツールで以下を確認：

```bash
# ブラウザでアクセス
http://localhost:8081

# 開発者ツール（F12） > Network タブ
# セッション一覧を開いた時のリクエストを確認：
# - GET /api/sessions?project=xxx
# - レスポンスボディの内容
# - ステータスコード
```

### 2. バックエンドのログ確認

サーバーのログファイルを確認して、リクエストが到達しているか確認：

```bash
tail -f .claude/skills/server-management/server.log
```

期待されるログ：
- `ListSessions` が呼ばれている
- プロジェクト名が正しく渡されている
- データベースクエリが実行されている

### 3. 直接APIを叩いて確認

curlでバックエンドAPIを直接テスト：

```bash
# プロジェクト一覧を取得
curl http://localhost:8081/api/projects

# 特定プロジェクトのセッション一覧を取得
# ⚠️ プロジェクト名はエンコードされている可能性があるので注意
curl "http://localhost:8081/api/sessions?project=-Users-{username}-Documents-GitHub-CCLogAnalysis"

# または全セッション
curl http://localhost:8081/api/sessions
```

### 4. フロントエンドのコード確認

以下のファイルを確認：

- `web/src/lib/api/client.ts` - API クライアントの実装
- `web/src/lib/api/types.ts` - レスポンス型定義
- `web/src/components/sessions/SessionListTab.tsx` - セッション一覧の表示ロジック
- `web/src/pages/ProjectsPage.tsx` - プロジェクトページの実装

特に確認すべきポイント：
- `listSessions` 関数のパラメータ
- プロジェクト名のエンコーディング
- エラーハンドリング

### 5. デバッグログの追加

必要に応じて、以下の箇所にデバッグログを追加：

**バックエンド** (`internal/api/handlers.go` の `listSessionsHandler`):
```go
log.InfoWithContext("ListSessions called", map[string]interface{}{
    "project": projectName,
})

// ... セッション取得後
log.InfoWithContext("Sessions retrieved", map[string]interface{}{
    "count": len(sessions),
})
```

**フロントエンド** (`web/src/lib/api/client.ts`):
```typescript
console.log('Fetching sessions for project:', project);
// ... レスポンス受信後
console.log('Received sessions:', data);
```

## 重要なファイル

### バックエンド

- `internal/api/router.go` - ルーティング設定
- `internal/api/service_db.go` - ListSessions の実装
- `internal/db/sessions.go` - データベースクエリ

### フロントエンド

- `web/src/lib/api/client.ts` - API クライアント
- `web/src/components/sessions/SessionListTab.tsx` - セッション一覧UI

### 診断

- `internal/api/debug.go` - デバッグエンドポイント
- `.claude/skills/server-management/server.log` - サーバーログ

## 期待される結果

問題を特定して修正した後、以下のようになるべき：

1. フロントエンドのセッション一覧に、データベース内のセッションが正しく表示される
2. プロジェクトでフィルタリングした場合、そのプロジェクトのセッションのみ表示される
3. セッション数が正しくカウントされる

## 参考情報

### プロジェクト構成

```
CCLogAnalysis/
├── cmd/server/           # サーバーエントリポイント
├── internal/
│   ├── api/             # REST API実装
│   ├── db/              # データベース層
│   ├── logger/          # ログ機能
│   └── parser/          # ログパーサー
├── web/                 # Reactフロントエンド
│   ├── src/
│   │   ├── lib/api/    # APIクライアント
│   │   ├── components/ # Reactコンポーネント
│   │   └── pages/      # ページコンポーネント
└── .claude/
    └── skills/
        └── server-management/ # サーバー管理スクリプト
```

### コミット履歴

最新のコミット：
1. `8d5e630` - fix: サーバー管理スクリプトとフロントエンドの型エラーを修正
2. `a4697f5` - Merge branch 'main' into investigate-session-pickup-issue
3. 前回のコミット群 - 診断機能実装、エラーハンドリング改善

## 注意事項

- サーバーは現在 http://localhost:8081 で起動中
- LOG_LEVEL=DEBUG で詳細ログが出力される
- プロジェクト名はURLエンコードされている可能性がある（例: スラッシュが `-` に変換）
- ワークツリー環境なので、同じセッションが複数のプロジェクトで見つかる可能性がある
