# WIP: git_root検出改善とデータ同期問題調査

**日付**: 2026-01-25
**ブランチ**: project-summary

## 作業概要

Git Worktreeプロジェクトのグループ化において、git_root検出が失敗している問題を調査・修正しました。また、データ同期時に発生している複数の問題を発見しました。

## 実施した修正

### 1. Parser: 複数セッションのcwd検出対応

**問題**:
- `GetProjectWorkingDirectory()` が最初のセッションのみをチェック
- 古いClaude Codeセッションはcwdフィールドを持たないため、検出に失敗

**修正内容**:
- `internal/parser/parser.go` の `GetProjectWorkingDirectory()` を修正
- 複数のセッションをループでチェックし、cwdが見つかるまで継続
- cwdが見つかったら即座に返す

**テスト追加**:
- `TestGetProjectWorkingDirectory_FirstSessionNoCwd`: 最初のセッションにcwdがない場合
- `TestGetProjectWorkingDirectory_AllSessionsNoCwd`: すべてのセッションにcwdがない場合

**結果**:
✅ voxmentグループに7つのプロジェクトが正しくグループ化された
- voxment本体
- 現在存在する6つのワークツリー（1105, 1117, 1118, 1119, 1120, 1127）

✅ 合計4つのプロジェクトでgit_rootが正しく設定された
- CCLogAnalysis
- open-claude-code
- thedotmack
- voxment

## 発見された問題

### 1. セッション同期時のUUID重複エラー

**現象**:
```
Warning: failed to save session {project}/{session}: failed to insert log entry: UNIQUE constraint failed: log_entries.uuid
```

**影響**:
- 多数のプロジェクトでセッション同期が失敗
- 例: 1105プロジェクトはファイルシステムに4セッション存在するが、DBには0セッション

**頻度**: 非常に多い（ログに大量に出力）

**原因**: 未調査
- log_entries テーブルのuuidカラムにUNIQUE制約があるが、重複したUUIDが挿入されようとしている
- ファイルウォッチャーによる重複同期の可能性？
- 同一セッションの複数エントリで同じUUIDが使用されている可能性？

### 2. セッション同期時のsessions.id重複エラー

**現象**:
```
Warning: failed to save session {project}/{session}: failed to insert session: UNIQUE constraint failed: sessions.id
```

**影響**:
- セッション同期が失敗
- 主にagentセッション（サブエージェント）で発生

**頻度**: 多い

**原因**: 未調査
- sessions テーブルのidカラムにUNIQUE制約があるが、重複したIDが挿入されようとしている
- 親セッションとサブエージェントのIDの衝突？

### 3. 削除されたワークツリーのgit_root検出失敗

**現象**:
```
Warning: failed to detect git root for existing project: project path does not exist
```

**影響**:
- 削除済みワークツリーのgit_rootがNULLのまま
- 削除済みワークツリーが独立したグループとして表示される

**判定**: これは正常な動作
- プロジェクトパスが存在しない場合、git root検出は不可能
- 過去のセッションデータは保持しつつ、現在のファイルシステム状態を反映している

## 次のステップ

### 優先度高: UUID/セッションID重複エラーの調査・修正

1. **原因特定**:
   - `internal/db/sync.go` のセッション保存ロジックを調査
   - log_entries と sessions のUNIQUE制約を確認
   - ファイルウォッチャーの動作確認（重複同期の有無）

2. **再現テスト作成**:
   - 重複エラーが発生する最小ケースを特定
   - テストケースを作成

3. **修正方針検討**:
   - INSERT OR IGNORE を使用？
   - 事前に存在チェック？
   - トランザクション管理の見直し？

### 優先度中: Git Worktreeグループのソート機能

ユーザー要求:
- Git Worktree基準のグループ（git_root != NULL）を上位に表示
- スタンドアロンプロジェクト（git_root = NULL）を下位に表示

実装方針:
- API側でソート処理を追加
- フロントエンド側でソート表示

## 関連ファイル

### 修正済み
- `internal/parser/parser.go`: GetProjectWorkingDirectory() の複数セッション対応
- `internal/parser/parser_test.go`: テストケース追加

### 要調査
- `internal/db/sync.go`: セッション同期ロジック
- `internal/db/sessions.go`: セッション保存処理
- `internal/db/migrations/`: log_entriesとsessionsのUNIQUE制約定義

## メモ

- データベースを削除・再作成しても同じエラーが発生 → データ起因ではなくロジック起因の可能性が高い
- ファイルシステム上のプロジェクト数: 105
- API経由で取得できるプロジェクト数: 105
- git_rootが設定されているグループ数: 4
- スタンドアロングループ数: 95
