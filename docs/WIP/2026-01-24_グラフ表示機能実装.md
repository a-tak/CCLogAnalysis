# WIP: グラフ表示機能実装（2026-01-24）

## セッション情報

- **日付**: 2026-01-24
- **作業時間**: 約4時間
- **開発方針**: テスト駆動開発（TDD）継続

---

## 完了した作業

### 1. Go embedでフロントエンド統合（完了 ✅）

#### 実装内容

- [x] `internal/static/embed.go` 作成
  - `//go:embed dist` でフロントエンドを埋め込み
  - `web/dist` → `internal/static/dist` にビルド時コピー
- [x] `spaHandler` 構造体実装
  - `index.html` を初期化時にキャッシュ
  - ファイル存在確認 → `http.FileServer` で提供
  - ファイル不在 → `index.html` 返却（SPAルーティング）
  - APIパス（`/api/*`）は処理しない
- [x] `Routes()` メソッド更新
  - `newSPAHandler(static.Files)` でハンドラー作成
  - `http.StripPrefix` を使用して静的ファイル提供
- [x] CORS設定を環境変数で制御
  - `ENABLE_CORS=true` で開発時のみ有効化
- [x] 静的ファイルテスト11件追加
  - `TestStaticFileServing` (4テスト)
  - `TestSPARouting` (4テスト)
  - `TestAPIEndpointsPriority` (3テスト)
- [x] Makefile作成
  - `build`, `build-frontend`, `build-backend`
  - `test`, `clean`, `dev`, `run`, `help`
- [x] README.md更新
  - ビルド手順追加
  - 開発モードの説明

#### テスト結果

```bash
go test ./... -v
→ 24 PASS (API 16 + Parser 8)
```

---

### 2. Tailwind CSS v4設定の修正（完了 ✅）

#### 問題

初期実装でTailwind CSS v3の`@tailwind`ディレクティブを使用していたため、カスタムユーティリティクラス（`bg-background`, `text-foreground`など）が生成されず、デザインが適用されていなかった。

#### 診断結果

- CSSファイルは200で配信されている ✅
- Reactアプリは動作している ✅
- しかし、`bg-background`などのクラスがCSS内に存在しない ❌
- computed styleは白背景のまま（CSS変数が適用されていない）

#### 解決策

**Tailwind CSS v4の正しい設定方法**:

1. `@import "tailwindcss"` でTailwindを読み込む（v3の`@tailwind`の代わり）
2. `@theme` ディレクティブでカスタムカラーを定義
3. カラー変数は `--color-*` 形式を使う（v4の規約）
4. `@tailwindcss/vite` プラグインを使用
5. `tailwind.config.js`や`postcss.config.js`は不要（v4では）

#### 実装内容

**`web/src/index.css`**:
```css
@import "tailwindcss";

@theme {
  /* Custom colors using CSS variables */
  --color-background: hsl(0 0% 100%);
  --color-foreground: hsl(222.2 84% 4.9%);
  --color-primary: hsl(221.2 83.2% 53.3%);
  /* ... その他のカラー変数 */
  --radius: 0.5rem;
}

@layer base {
  * {
    border-color: var(--color-border);
  }
  body {
    background-color: var(--color-background);
    color: var(--color-foreground);
  }
}
```

**`web/vite.config.ts`**:
```typescript
import tailwindcss from '@tailwindcss/vite'

export default defineConfig({
  plugins: [
    react(),
    tailwindcss(),
  ],
  // ...
})
```

#### 結果

- CSSサイズ: 5.99kB → **17.42kB** ✨（カスタムクラス生成確認）
- `bg-background`クラスが3回検出
- デザインが正しく適用（ヘッダー、カード、タイポグラフィ）
- Tailwind v4を使用（2024年12月リリースの最新版）

---

### 3. グラフ表示機能実装（完了 ✅）

#### 実装内容

**新規作成ファイル**:

1. **`web/src/components/charts/TokenBreakdownChart.tsx`**
   - 円グラフ（Pie Chart）
   - トークン種別の内訳を表示
     - Input Tokens（青）
     - Output Tokens（紫）
     - Cache Creation（アクセント）
     - Cache Read（ミュート）
   - 値が0のアイテムは非表示
   - パーセンテージラベル表示
   - Recharts使用

2. **`web/src/components/charts/ModelUsageChart.tsx`**
   - 棒グラフ（Stacked Bar Chart）
   - モデル別トークン使用量を表示
   - 4種類のトークンをスタック表示
   - モデル名を短縮表示（`claude-`と日付を削除）
   - Recharts使用

**更新ファイル**:

3. **`web/src/pages/SessionDetailPage.tsx`**
   - Token Usageセクションを2カラムレイアウトに変更
     - 左: 数値一覧（既存）
     - 右: 円グラフ（新規）
   - Model Usageセクションにグラフ追加
     - 棒グラフ（新規）
     - テーブル（既存、下部に配置）

#### ビルド結果

```bash
make build
✓ built in 1.14s
dist/assets/index-CnwewdQT.css   17.75 kB
dist/assets/index-CmjCW9Sv.js   640.17 kB  # Rechartsを含む

⚠️ Warning: Chunk size > 500kB (code splittingを検討)
```

#### TypeScript修正

Rechartsの型定義問題を修正：
- `percent` が `undefined` の可能性に対応
- `value` の型アサーション追加

#### 色の問題修正（完了 ✅）

**問題**:
- CSS変数（`var(--color-*)`）を使用していたが、secondary/accent/mutedが全て同じ明るいグレーだった
- グラフが真っ黒または見分けがつかない状態

**解決策**:
- ハードコードされたHSL値を使用
  - Blue (`hsl(221.2 83.2% 53.3%)`): Input tokens
  - Purple (`hsl(262 83% 58%)`): Output tokens
  - Orange (`hsl(25 95% 53%)`): Cache Creation
  - Gray (`hsl(215 16.3% 46.9%)`): Cache Read

**動作確認**:
- [x] セッション詳細ページにアクセス
- [x] 円グラフが正しく表示されているか ✅
- [x] 棒グラフが正しく表示されているか ✅
- [x] グラフの色が正しいか ✅（鮮やかな色で表示）
- [x] ツールチップが動作するか ✅
- [x] レスポンシブレイアウトが機能するか ✅

**スクリーンショット**:
- `.playwright-mcp/graph-before-fix.png`: 修正前（真っ黒）
- `.playwright-mcp/graph-after-fix.png`: 修正後（色分け完璧）
- `.playwright-mcp/token-breakdown-chart.png`: 円グラフ拡大
- `.playwright-mcp/model-usage-chart.png`: 棒グラフ拡大

---

## 既知の問題

### 1. プロジェクトパスデコード

現在の実装は簡易的（継続中の既知の問題）

---

## コミット履歴

```bash
31bcb0e - Embed React frontend into Go binary
008dffd - Fix Tailwind CSS v4 configuration
83a8d70 - Fix static file serving with http.StripPrefix
fbbbaed - Fix Tailwind CSS v4 configuration properly
7e29a86 - Add graph visualization with Recharts ✅
```

---

## 次のステップ

### 優先度: 高（次のセッションで実施）

1. **会話履歴表示機能**
   - メッセージとツール呼び出しの詳細表示
   - エラーの強調表示
   - シンタックスハイライト

### 優先度: 中

2. **UI/UX改善**
   - ダークモード対応
   - レスポンシブデザイン改善
   - ページネーション追加

### 優先度: 低

3. **パフォーマンス最適化**
   - Code splitting（現在640kB、警告あり）
   - Dynamic import()の使用
   - Lazy loading

4. **SQLiteデータベース導入**
   - 解析結果の永続化
   - 過去データとの比較

---

## 技術スタック（最終確定）

### フロントエンド

- React 19.2.0
- TypeScript 5.9.3
- Vite 7.3.1
- React Router DOM 7.x
- **Tailwind CSS 4.1.18** ← v4に統一
- shadcn/ui（手動実装）
- **Recharts 3.7.0** ← グラフ表示に使用

### バックエンド

- Go 1.25.6
- 標準ライブラリのみ
- CORS サポート（環境変数制御）

### 配布

- 1バイナリ配布（Go embed）
- バイナリサイズ: 約10MB（フロントエンド埋め込み済み）

---

## ファイル構成（追加分）

```
web/src/components/charts/
├── TokenBreakdownChart.tsx    # 円グラフコンポーネント
└── ModelUsageChart.tsx        # 棒グラフコンポーネント

internal/static/
├── embed.go                   # Go embedディレクティブ
└── dist/                      # ビルド成果物（.gitignore）

Makefile                       # ビルド自動化
```

---

## 開発環境

- Go: 1.25.6
- Node.js: 25.2.1
- npm: 11.6.2
- OS: macOS (Darwin 25.2.0)

---

## メモ

- Tailwind CSS v4は2024年12月リリース
- `@import "tailwindcss"` と `@theme` が新しい書き方
- Rechartsのバンドルサイズが大きい（640kB）→ code splittingを検討
- Playwrightでの動作確認が必須（前回の教訓）
- 個人情報は含めない（パブリック公開前提）

---

**次のセッションで作業を再開する際は、このドキュメントを参照してください。**

## セッション完了サマリー

### 達成したこと ✅
1. Go embedでフロントエンド統合（1バイナリ配布実現）
2. Tailwind CSS v4設定の修正（カスタムユーティリティクラス生成）
3. グラフ表示機能実装と色の問題修正
   - 円グラフ（Token Breakdown）
   - 棒グラフ（Model Usage）
   - Playwrightで動作確認完了

### コミット済み
- fbbbaed: Fix Tailwind CSS v4 configuration properly
- 7e29a86: Add graph visualization with Recharts

### 次のセッションの推奨作業
1. 会話履歴表示機能の実装
2. UI/UX改善（ダークモード、レスポンシブデザイン）
