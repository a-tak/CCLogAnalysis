# WIP: Go embed統合（2026-01-24）

## セッション情報

- **日付**: 2026-01-24
- **作業時間**: 約1.5時間
- **開発方針**: テスト駆動開発（TDD）

---

## 完了した作業

### 1. 静的ファイルテスト実装（TDD Red）

- [x] `internal/api/static_test.go` 作成
  - `TestStaticFileServing` - 静的ファイル提供（4テスト）
  - `TestSPARouting` - SPAルーティング（4テスト）
  - `TestAPIEndpointsPriority` - API優先度（3テスト）
  - `TestStaticFileContentTypes` - Content-Type確認（2テスト）
- [x] テスト失敗確認（8失敗、3成功）

### 2. Go embed実装（TDD Green）

#### 課題と解決

**問題**: Go embedディレクティブは`..`パスをサポートしない

**試行1**: `internal/api/router.go`で直接embed
```go
//go:embed ../../web/dist
var staticFiles embed.FS
```
→ **失敗**: `invalid pattern syntax`

**試行2**: シンボリックリンク作成
```bash
ln -s ../../web/dist internal/static/dist
```
→ **失敗**: Go embedがシンボリックリンクを再帰的に処理してエラー

**最終解決策**: ビルドプロセスで実ファイルをコピー
- `internal/static` パッケージ作成
- `internal/static/embed.go` でembedディレクティブ定義
- Makefileでビルド時に `web/dist` → `internal/static/dist` にコピー
- `.gitignore` に `internal/static/dist/` 追加

#### 実装内容

- [x] `internal/static/embed.go` 作成
  ```go
  package static

  import "embed"

  //go:embed dist
  var Files embed.FS
  ```
- [x] `spaHandler` 構造体実装
  - `index.html` を初期化時にキャッシュ
  - ファイルが存在する場合は `http.FileServer` で提供
  - ファイルが存在しない場合は `index.html` を返す（SPAルーティング）
  - APIパス（`/api/*`）は処理しない
- [x] `Routes()` メソッドに静的ファイルハンドラー追加
  - `newSPAHandler(static.Files)` でハンドラー作成
  - `mux.Handle("/", spaHandler)` で登録
- [x] CORS設定を環境変数で制御
  - `ENABLE_CORS=true` で開発時のみCORS有効化
  - 本番では無効（同一オリジン配信）

### 3. Makefile作成

- [x] ビルドプロセスの自動化
  - `build-frontend`: React ビルド + `internal/static/dist` にコピー
  - `build-backend`: Goバイナリビルド
  - `build`: フロントエンド→バックエンドの順序保証
- [x] 開発・テスト・クリーンアップコマンド
  - `dev`: CORS有効でバックエンド起動
  - `test`: 全テスト実行
  - `clean`: ビルド成果物削除
  - `run`: ビルド後に実行
  - `help`: コマンド一覧表示

### 4. README.md更新

- [x] ビルド手順セクション追加
  - 本番用ビルド手順
  - 実行方法
  - クリーンビルド
- [x] 開発モードセクション更新
  - フロントエンド・バックエンド分離開発の説明
  - CORS設定の説明
  - Makeコマンド一覧追加
- [x] 開発状況の更新
  - テスト数: 13 → 24
  - React UI基本実装完了
  - Go embed統合完了

### 5. .gitignore更新

- [x] `internal/static/dist/` を除外リストに追加

---

## テスト結果

### TDD Red（失敗確認）

```bash
go test ./internal/api -v -run "TestStatic|TestSPA|TestAPI"
→ 8 FAIL, 3 PASS（期待通り）
```

### TDD Green（実装後）

```bash
go test ./internal/api -v
→ 16 PASS
  - 既存APIテスト: 5 PASS
  - 新規静的ファイルテスト: 11 PASS

go test ./... -v
→ 24 PASS
  - API tests: 16 PASS
  - Parser tests: 8 PASS
```

### ビルド確認

```bash
make build
→ 成功
  - フロントエンドビルド: 474ms
  - バックエンドビルド: 成功
  - バイナリサイズ: 約10MB（フロントエンド埋め込み済み）
```

### 動作確認

```bash
./bin/ccloganalysis

# テスト結果
✅ http://localhost:8080/api/health → {"status":"ok"}
✅ http://localhost:8080/ → HTML（<div id="root">含む）
✅ http://localhost:8080/projects/test → HTML（SPAルーティング）
✅ http://localhost:8080/api/projects → JSON（104 projects）
✅ ページリロードでも正しく表示
```

---

## 技術的な詳細

### Go embedの制約

1. **パス制限**:
   - `..` を使った上位ディレクトリへのアクセス不可
   - embedディレクティブはそのGoファイルのディレクトリ以下のみアクセス可能

2. **シンボリックリンクの問題**:
   - Go embedはシンボリックリンクをたどって実ファイルを処理
   - リンク先に再帰的なディレクトリ構造があるとエラー

3. **解決策**:
   - 専用の`internal/static`パッケージでembed
   - ビルド時に実ファイルをコピー
   - `.gitignore`でコピー先を除外

### SPAハンドラーの実装

```go
type spaHandler struct {
    staticFS   http.FileSystem
    indexBytes []byte  // キャッシュ
}

func (h *spaHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    // 1. APIパスはスキップ
    // 2. ルートパス → index.html
    // 3. ファイル存在確認 → FileServerで提供
    // 4. ファイル不在 → index.html（SPAルーティング）
}
```

**パフォーマンス最適化**:
- `index.html`を初期化時にメモリキャッシュ
- ファイル存在確認のみで、本体はGo標準の`http.FileServer`に委譲
- MIME typeは`http.FileServer`が自動設定

### CORS設定

- **本番**: 同一オリジン配信のため無効
- **開発**: `ENABLE_CORS=true`で有効化
  - フロントエンド: http://localhost:5173（Vite）
  - バックエンド: http://localhost:8080

---

## ビルド成果物

```
bin/
└── ccloganalysis          # 単一実行ファイル（約10MB）
    ├── Goバイナリ
    └── React UI（embed）
        ├── index.html
        ├── assets/
        │   ├── index-*.js
        │   └── index-*.css
        └── vite.svg
```

---

## 次のステップ

### 優先度: 高

1. **グラフ表示機能**
   - Rechartsを使用してトークン使用量を可視化
   - 時系列グラフ、円グラフ
   - セッション詳細ページに追加

2. **会話履歴表示**
   - メッセージとツール呼び出しの詳細表示
   - エラーの強調表示
   - シンタックスハイライト

### 優先度: 中

3. **UI/UX改善**
   - ダークモード対応
   - レスポンシブデザイン
   - ページネーション追加

4. **配布準備**
   - GitHub Releases設定
   - バイナリの自動ビルド（CI/CD）
   - インストール手順の整備

### 優先度: 低

5. **SQLiteデータベース導入**
   - 解析結果の永続化
   - 過去データとの比較

---

## 既知の問題

### 1. プロジェクトパスデコード

現在の実装は簡易的（既知の問題、継続）

### 2. ビルドプロセスの依存関係

- `make build-backend` は `web/dist` の存在が前提
- `make build` を使えば自動的に順序保証される
- CI/CDでは必ず `make build` を使用すること

---

## コミット情報

```bash
# 予定コミット
git add .
git commit -m "Embed React frontend into Go binary

- Add embed directive to internal/static package
- Implement spaHandler for SPA routing
- Add 11 new test cases for static file serving
- Create Makefile for build automation
- Update CORS to use environment variable
- Update README with build instructions
- Update .gitignore for embedded files

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## 開発環境

- Go: 1.25.6
- Node.js: 25.2.1
- npm: 11.6.2
- OS: macOS (Darwin 25.2.0)

---

## メモ

- TDD方針継続（全テストパス状態を維持）
- 個人情報は含めない（パブリック公開前提）
- Go embedの制約により`internal/static`パッケージを作成
- ビルドプロセスで`web/dist`をコピーする方式に決定
- 1バイナリ配布が実現（約10MB）

---

**次のセッションで作業を再開する際は、このドキュメントを参照してください。**
