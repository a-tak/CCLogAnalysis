# Claude Code ログフォーマット調査

## 調査日
2026-01-24

## ログファイルの場所

```
C:\Users\{ユーザー名}\.claude\projects\
```

各プロジェクト（ワークツリー）ごとにフォルダが作成され、その中に `.jsonl` ファイルとして保存される。

### 実例
```
C:\Users\{username}\.claude\projects\
├── C--Users-{username}--claude-worktrees-my-project-feature-branch\
│   └── 1db6d9ff-a7c7-4ae1-8810-2601e6bfb8d7.jsonl
└── F--GitHub-my-project-worktrees-1058-refactor-module\
    └── 8bef4bf2-b4a6-407a-ba94-37e4569a4a96.jsonl
```

- フォルダ名: プロジェクトパスをエンコードしたもの
- ファイル名: セッションID.jsonl

---

## ログフォーマット

### フォーマット形式
**JSONL（JSON Lines）**: 1行に1つのJSONオブジェクト

### エントリの種類

各ログエントリには `type` フィールドがあり、以下の種類が存在する:

| type | 説明 |
|------|------|
| `user` | ユーザーのメッセージ |
| `assistant` | AIのメッセージ |
| `queue-operation` | セッション開始などの操作 |
| `file-history-snapshot` | ファイル履歴のスナップショット |

---

## 共通フィールド

すべてのエントリに含まれる基本情報:

```json
{
  "type": "user | assistant | queue-operation | ...",
  "timestamp": "2026-01-11T03:24:10.137Z",
  "sessionId": "1db6d9ff-a7c7-4ae1-8810-2601e6bfb8d7",
  "uuid": "c4354466-7056-4e8f-ba40-de93726d2424",
  "parentUuid": "...",  // 親メッセージのUUID（会話の流れを追跡）
  "cwd": "C:\\Users\\{username}\\.claude-worktrees\\my-project\\feature-branch",
  "version": "2.0.72",
  "gitBranch": "feature-branch"
}
```

### フィールド詳細

| フィールド | 説明 | 例 |
|-----------|------|-----|
| `timestamp` | ISO 8601形式のタイムスタンプ | `2026-01-11T03:24:10.137Z` |
| `sessionId` | セッション全体の一意なID | UUID形式 |
| `uuid` | このメッセージの一意なID | UUID形式 |
| `parentUuid` | 親メッセージのUUID（会話ツリー構造） | UUID or `null` |
| `cwd` | 作業ディレクトリ | Windowsパス |
| `gitBranch` | Gitブランチ名 | 文字列 |
| `version` | Claude Codeのバージョン | `2.0.72` |

---

## Assistantメッセージの構造

AIの応答メッセージには、**重要なトークン使用量情報**が含まれる:

```json
{
  "type": "assistant",
  "message": {
    "model": "claude-haiku-4-5-20251001",
    "id": "msg_01GGB5cUaYwenenVYQpgcBcd",
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "こんにちは！..."
      }
    ],
    "usage": {
      "input_tokens": 2,
      "output_tokens": 1,
      "cache_creation_input_tokens": 41187,
      "cache_read_input_tokens": 0,
      "cache_creation": {
        "ephemeral_5m_input_tokens": 41187,
        "ephemeral_1h_input_tokens": 0
      },
      "service_tier": "standard"
    }
  },
  "requestId": "req_011CWzsfUkbBWbqCXXEjavmC"
}
```

### トークン使用量フィールド

| フィールド | 説明 |
|-----------|------|
| `input_tokens` | 入力トークン数 |
| `output_tokens` | 出力トークン数 |
| `cache_creation_input_tokens` | キャッシュ作成に使用した入力トークン |
| `cache_read_input_tokens` | キャッシュから読み取ったトークン |
| `service_tier` | サービスティア（`standard`） |

**重要**: これらの情報から**モデル別・セッション別のトークン使用量を集計可能**

---

## ツール呼び出しの構造

AIがツール（Bash, Read, Edit など）を呼び出す際の記録:

```json
{
  "type": "assistant",
  "message": {
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_01H3HCPPykaC9phNTWE6sp3w",
        "name": "Bash",
        "input": {
          "command": "pwd",
          "description": "確認現在の作業ディレクトリ"
        },
        "caller": {
          "type": "direct"
        }
      }
    ]
  }
}
```

### ツール結果の記録

```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": [
      {
        "tool_use_id": "toolu_01H3HCPPykaC9phNTWE6sp3w",
        "type": "tool_result",
        "content": "/c/Users/{username}/.claude-worktrees/my-project/feature-branch",
        "is_error": false
      }
    ]
  },
  "toolUseResult": {
    "stdout": "...",
    "stderr": "...",
    "interrupted": false,
    "isImage": false
  }
}
```

**重要**: これらの情報から**試行錯誤パターン・エラー頻度を分析可能**

---

## 会話の流れの追跡

`parentUuid` フィールドを使って会話ツリーを構築できる:

```
queue-operation (parentUuid: null)
  └─> user message (uuid: A, parentUuid: null)
      └─> assistant message (uuid: B, parentUuid: A)
          └─> user message (tool result) (uuid: C, parentUuid: B)
              └─> assistant message (uuid: D, parentUuid: C)
```

---

## データサイズ

### 観察されたファイルサイズ
- 小規模セッション: 約100行（数KB）
- 大規模セッション: **94,955トークン相当**（数MB）

→ 大容量ログへの対応が必要

---

## 抽出可能な情報まとめ

### ✅ 実現可能な解析

| 分析項目 | 取得元フィールド |
|---------|----------------|
| **トークン使用量** | `message.usage.input_tokens`, `output_tokens` |
| **モデル情報** | `message.model` |
| **時間情報** | `timestamp` |
| **ツール呼び出し履歴** | `message.content[].type === "tool_use"` |
| **エラー発生** | `toolUseResult.is_error`, `stderr` |
| **会話の流れ** | `parentUuid` によるツリー構築 |
| **作業ディレクトリ** | `cwd` |
| **Gitブランチ** | `gitBranch` |

### ⚠️ 課題・注意点

1. **大容量ログ**: 数万行のJSONLファイルを効率的に処理する必要がある
2. **複数ファイル**: 1セッション = 1ファイルなので、複数セッションをまたいだ分析が必要
3. **エンコードされたパス**: プロジェクトフォルダ名がエンコードされているため、デコード処理が必要

---

## 次のアクション

1. JSONLパーサーの実装
2. トークン使用量集計ロジックの設計
3. セッション統合・グループ化ロジックの設計
