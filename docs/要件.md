# Claude Code ログ解析アプリケーション 要件定義

## 1. プロジェクト概要

### 目的
Claude Codeに対する各種調整（モデル選択、プロンプト設定など）の効果を、ログ解析を通じて定量的に評価・可視化する。

### 背景・課題
- 現状、調整の効果は「感覚」や「常時監視」でしか把握できない
- データに基づいた客観的な評価ができていない
- 同じ間違いを繰り返すパターンの把握ができていない

---

## 2. 評価対象となるユースケース

### モデル使用の最適化
| 用途 | 現状 | 検討中の変更 |
|------|------|--------------|
| コーディング | Sonnet | Haiku |
| 計画・設計 | Opus | Opus（維持） |
| 難問解決 | - | Opusエージェントに委譲 |

### 検証したい仮説の例
- Haikuでもコーディング品質は維持できるか
    - トークン使用量は削減できる
    - 全体の作業効率は下がらないか
- サブエージェントやスキルの活用でコンテキストが削減できるか
---

## 3. 評価軸（KPI）

### 3.1 トークン使用量
- **入力トークン数**: セッション/タスクごとの消費量
- **出力トークン数**: セッション/タスクごとの消費量
- **モデル別内訳**: Haiku / Sonnet / Opus それぞれの使用量
- **コスト換算**: 使用量を金額に変換

### 3.2 時間効率
- **解決までの所要時間**: タスク開始から完了までの経過時間
- **実作業時間**: AIが実際に処理していた時間
- **待機時間**: ユーザー入力待ちなどのアイドル時間

### 3.3 試行錯誤パターン分析
- **リトライ回数**: 同一タスクでの再試行回数
- **エラーパターン**: 繰り返し発生するエラーの分類
- **失敗→成功パターン**: どのような手順で解決に至ったか
- **一発成功率**: 最初の試行で成功した割合

---

## 4. 機能要件

### Phase 1: MVP（最小限の機能）

#### 4.1 ログ取り込み機能
- [x] Claude Codeのログファイル読み込み（`internal/parser/parser.go`）
- [x] ログフォーマットのパース（`internal/parser/parser.go`）
- [x] セッション/タスク単位での分割（`internal/parser/parser.go`）

#### 4.2 やり取り確認機能
- [x] セッション一覧表示（`web/src/pages/SessionsPage.tsx`）
- [x] 各セッションのやり取り（会話履歴）の閲覧（`web/src/pages/SessionDetailPage.tsx`）
- [x] ツール呼び出し履歴の表示（`web/src/pages/SessionDetailPage.tsx`）

#### 4.3 基本解析機能
- [x] トークン使用量の集計（`internal/parser/parser.go`）
- [x] モデル別使用量の内訳（`internal/parser/parser.go`、UI表示済み）
- [x] 時間計測・集計（`internal/parser/parser.go`）

#### 4.4 基本レポート機能
- [x] セッションごとのサマリー表示（`web/src/pages/SessionDetailPage.tsx`）
- [x] トークン使用量レポート（グラフ表示: `web/src/components/charts/`）

---

### Phase 2: 拡張機能

#### 4.5 高度な解析機能
- [ ] エラーパターンの検出・分類（スキーマのみ準備済み）
- [ ] 試行錯誤シーケンスの抽出
- [ ] 一発成功率の算出

#### 4.6 タスク要約機能（将来拡張）
- [ ] タスクごとの内容要約（AI活用）
- [ ] タスク分類・タグ付け
- [ ] タスク種別ごとの傾向分析

#### 4.7 高度なレポート機能
- [ ] 期間別推移グラフ（日次/週次/月次のトークン使用量推移など）
- [x] モデル別比較レポート（セッション内のモデル使用量棒グラフ実装済み）
- [ ] 問題パターン一覧

#### 4.8 データ管理
- [x] 解析結果の保存（SQLite実装済み: `internal/db/`）
- [x] 過去データとの比較（DB版で実装済み）
- [ ] エクスポート機能（CSV/JSON）

---

## 5. ログデータの構造

### 5.1 ログの保存場所
- **場所**: `~/.claude/projects/` 配下
- **構造**: プロジェクトごとにフォルダが分かれている

### 5.2 Gitワークツリー対応（重要）
- 1つのリポジトリでも、Gitワークツリー機能により**複数のプロジェクトフォルダ**に分かれる
- 並行開発のため、関連する複数のワークツリーを**まとめて分析**する必要がある
- 単一フォルダ参照ではなく、**プロジェクトグループ**として管理

### 5.3 対応すべき構造
```
~/.claude/projects/
├── my-repo/              # メインのワークツリー
├── my-repo-feature-a/    # ワークツリー1
├── my-repo-feature-b/    # ワークツリー2
└── my-repo-bugfix/       # ワークツリー3
```

→ これらを「my-repoプロジェクト」としてグループ化して分析

---

## 6. 非機能要件

### 6.1 対応環境
- [x] 対応OS: **Windows + Mac**
- [x] 実行形態: **Webアプリ**（Goサーバー + ブラウザ）
- [x] 配布形態: **1バイナリ**（Go embedでフロントエンド埋め込み）

### 6.2 データ
- [x] ログファイルの保存場所対応: `~/.claude/projects/` 配下
- [x] 大容量ログへの対応（ストリーミング処理実装済み）
- [x] 複数プロジェクトフォルダの一括読み込み（同期機能で実装済み）
- [x] データ永続化: **SQLite**（ファイル1つで完結、`internal/db/`）

---

## 7. 決定事項・確定済み

### ログフォーマット ✅
- **調査完了**: [ログフォーマット調査.md](ログフォーマット調査.md) を参照
- JSONL形式、トークン数・モデル情報・タイムスタンプ等すべて取得可能

### UIの形態 ✅
- **Webアプリ**: Goサーバー + ブラウザ
- 1バイナリ配布（Go embedでフロントエンド埋め込み）

### プロジェクトグループの定義方法 ✅
- **両方対応**:
  - パターンマッチによる自動グループ化
  - 設定ファイルでの手動定義・調整

---

## 8. 次のステップ

1. ~~**Claude Codeのログフォーマット調査**~~ ✅ 完了
2. ~~アプリケーション形態の決定~~ ✅ 完了
3. ~~技術スタック選定~~ ✅ 完了（[技術スタック.md](技術スタック.md) 参照）
4. ~~**設計・実装開始**~~ ✅ 完了
   - ~~プロジェクト初期化~~ ✅
   - ~~基本構造の作成~~ ✅
   - ~~JSONLパーサーの実装~~ ✅
5. ~~**Phase 1 MVP実装**~~ ✅ 完了
   - ~~ログ取り込み機能~~ ✅
   - ~~やり取り確認機能~~ ✅
   - ~~基本解析機能~~ ✅
   - ~~基本レポート機能~~ ✅
   - ~~SQLite データベース層~~ ✅
   - ~~React UI実装~~ ✅
   - ~~グラフ表示機能~~ ✅
   - ~~ファイルシステム監視機能~~ ✅
6. **Phase 2 拡張機能** ← 次はここから
   - エラーパターンの検出・分類
   - エクスポート機能（CSV/JSON）
   - 問題パターン一覧
   - プロジェクトグループ機能（Gitワークツリー対応）
