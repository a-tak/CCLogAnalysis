# スキャン最適化実装プラン（ファイル更新日時チェック）

## 概要

初期スキャン非同期化は完了しましたが、スキャン処理自体は毎回全ファイルをチェックしています。ファイルシステムの更新日時（modTime）を活用して、2回目以降のスキャン時間を大幅に短縮します。

**関連ドキュメント**: `docs/WIP/2026-01-25_初期スキャン非同期化実装完了.md`

## 目標

- 2回目以降のスキャンで更新されたファイルのみをパース
- データベースに最終スキャン時刻とファイル更新時刻を記録
- 既存の`SyncAll`の動作は変更しない（後方互換性維持）

**期待される効果**（12,788セッションの場合）:
- 初回スキャン: 約10秒（変わらず）
- 2回目スキャン（変更なし）: 約10秒 → **約1秒**
- 2回目スキャン（10%更新）: 約10秒 → **約2秒**

---

## 実装Phase

### Phase 1: データベーススキーマ変更

**目的**: ファイル更新日時とスキャン時刻を記録するカラムを追加

#### 実装内容

1. **テスト作成** (`internal/db/db_test.go`):
   - マイグレーション005が正しく適用されることを確認
   - `sessions.file_mod_time`カラムが存在することを確認
   - `projects.last_scan_time`カラムが存在することを確認
   - 既存データが保持されることを確認

2. **マイグレーション作成** (`internal/db/migrations/005_file_mod_time.sql`):
   ```sql
   -- テーブル再作成方式（003/004と同じパターン）

   -- sessions テーブル: file_mod_time TEXT 追加
   CREATE TABLE sessions_new (..., file_mod_time TEXT);
   INSERT INTO sessions_new SELECT ..., NULL as file_mod_time FROM sessions;
   DROP TABLE sessions;
   ALTER TABLE sessions_new RENAME TO sessions;

   -- projects テーブル: last_scan_time TEXT 追加
   CREATE TABLE projects_new (..., last_scan_time TEXT);
   INSERT INTO projects_new SELECT ..., NULL as last_scan_time FROM projects;
   DROP TABLE projects;
   ALTER TABLE projects_new RENAME TO projects;

   -- インデックスとトリガーの再作成
   ```

3. **マイグレーション登録** (`internal/db/db.go`):
   - `//go:embed migrations/005_file_mod_time.sql`
   - `runMigrations()`に追加

#### Critical Files
- `internal/db/migrations/005_file_mod_time.sql` (新規作成)
- `internal/db/db.go` (マイグレーション登録)
- `internal/db/db_test.go` (テスト追加)

---

### Phase 2: パーサー拡張（ファイル更新日時の取得）

**目的**: セッションファイルの更新日時を取得する機能を追加

#### 実装内容

1. **テスト作成** (`internal/parser/parser_test.go`):
   - `ListSessionsWithModTime`が正しく動作することを確認
   - modTimeが実際のファイルシステムと一致することを確認

2. **型定義** (`internal/parser/parser.go`):
   ```go
   type SessionFileInfo struct {
       SessionID string
       ModTime   time.Time
   }
   ```

3. **メソッド実装** (`internal/parser/parser.go`):
   ```go
   func (p *Parser) ListSessionsWithModTime(projectName string) ([]SessionFileInfo, error) {
       // os.ReadDir → entry.Info() → ModTime()
   }
   ```

#### Critical Files
- `internal/parser/parser.go` (型定義・メソッド追加)
- `internal/parser/parser_test.go` (テスト追加)

---

### Phase 3: DB層の拡張（更新日時の保存と取得）

**目的**: プロジェクトのスキャン時刻とセッションのファイル更新時刻を管理

#### 実装内容

1. **テスト作成** (`internal/db/projects_test.go`, `sessions_test.go`):
   - `UpdateProjectLastScanTime`/`GetProjectLastScanTime`のテスト
   - `CreateSession`に`file_mod_time`を渡すテスト

2. **メソッド追加** (`internal/db/projects.go`):
   ```go
   func (db *DB) UpdateProjectLastScanTime(projectID int64, scanTime time.Time) error
   func (db *DB) GetProjectLastScanTime(projectID int64) (*time.Time, error)
   ```

3. **CreateSession修正** (`internal/db/sessions.go`):
   - シグネチャ変更: `func CreateSession(session *parser.Session, projectName string, fileModTime time.Time) error`
   - INSERT文に`file_mod_time`を追加

#### Critical Files
- `internal/db/projects.go` (メソッド追加)
- `internal/db/sessions.go` (CreateSession修正)
- `internal/db/projects_test.go` (テスト追加)
- `internal/db/sessions_test.go` (テスト追加)

---

### Phase 4: SyncIncremental の実装

**目的**: 更新されたファイルのみをスキャンする増分同期機能

#### 実装内容

1. **テスト作成** (`internal/db/sync_test.go`):
   - 初回スキャンで全ファイルが同期される
   - 2回目のスキャンで全ファイルがスキップされる
   - ファイル更新時に該当ファイルのみが再同期される
   - 新規ファイルが検出される

2. **ヘルパー関数** (`internal/db/sync.go`):
   ```go
   func shouldSyncSession(sessionID string, fileModTime time.Time,
       lastScanTime *time.Time, db *DB) (bool, error) {
       // 新規セッション → true
       // last_scan_time が NULL → false (既存セッション)
       // fileModTime > lastScanTime → true (更新あり)
       // それ以外 → false
   }
   ```

3. **SyncIncremental実装** (`internal/db/sync.go`):
   - 現在: `return SyncAll(db, p)` を独立実装に変更
   - プロジェクトごとに`last_scan_time`を取得
   - `ListSessionsWithModTime`でファイル一覧を取得
   - `shouldSyncSession`で同期対象を判定
   - スキャン完了後、`UpdateProjectLastScanTime`を実行

#### Critical Files
- `internal/db/sync.go` (SyncIncremental完全書き換え) - **最重要**
- `internal/db/sync_test.go` (テスト追加)

---

### Phase 5: 既存コードの修正（後方互換性）

**目的**: 既存の`SyncAll`と統合し、全体の動作を維持

#### 実装内容

1. **テスト修正**:
   - 既存のテストが`CreateSession`のシグネチャ変更に対応

2. **SyncAll修正** (`internal/db/sync.go`):
   - `syncProjectInternalWithLogger`内で`ListSessionsWithModTime`を使用
   - `CreateSession`呼び出しに`info.ModTime`を追加

#### Critical Files
- `internal/db/sync.go` (syncProjectInternalWithLogger修正)

---

### Phase 6: 統合テストと検証

**目的**: 実データでパフォーマンス改善を確認

#### 実装内容

1. **ベンチマークテスト** (`internal/db/sync_benchmark_test.go`):
   ```go
   func BenchmarkSyncAll(b *testing.B)
   func BenchmarkSyncIncremental_NoChanges(b *testing.B)
   ```

2. **エッジケーステスト** (`internal/db/sync_test.go`):
   - タイムスタンプが巻き戻った場合
   - ファイル削除時（DBレコードは残る）

3. **実データテスト**:
   - 初回スキャン → 2回目スキャンの時間差を計測

---

## リスクと注意点

### 1. データ整合性
- **リスク**: マイグレーション中のデータ損失
- **対策**: テーブル再作成方式でデータを全てコピー、テストで検証

### 2. 後方互換性
- **リスク**: `CreateSession`のシグネチャ変更が既存コードに影響
- **対策**: 呼び出し箇所は`sync.go`のみ、全て修正して既存テストで検証

### 3. パフォーマンス
- **リスク**: `ListSessionsWithModTime`で全ファイルの`os.Stat`が必要
- **対策**: `DirEntry.Info()`は遅延評価、ベンチマークテストで計測

### 4. ファイル削除の検出
- **現在の実装では対応しない**: ファイルが削除されてもDBレコードは残る
- **将来対応**: orphan session cleanup機能として別途実装

---

## 検証方法（実装完了後）

### 1. 単体テスト
```bash
go test ./internal/db/... -v
go test ./internal/parser/... -v
```

### 2. ベンチマークテスト
```bash
go test ./internal/db -bench=. -benchmem
```

### 3. 実データテスト
```bash
# 初回スキャン
time ./ccloganalysis server

# 2回目スキャン（サーバー再起動）
time ./ccloganalysis server
```

### 4. データベース確認
```sql
-- マイグレーション適用確認
SELECT * FROM schema_migrations WHERE version = '005';

-- データ確認
SELECT id, file_mod_time FROM sessions LIMIT 10;
SELECT name, last_scan_time FROM projects;
```

---

## 実装順序（TDD）

1. **Phase 1**: マイグレーションテスト → マイグレーション実装
2. **Phase 2**: パーサーテスト → パーサー実装
3. **Phase 3**: DB層メソッドテスト → DB層メソッド実装
4. **Phase 4**: SyncIncrementalテスト → SyncIncremental実装
5. **Phase 5**: 既存テスト修正 → 既存コード修正
6. **Phase 6**: 統合テスト → ベンチマークテスト → 実データ検証

---

## Critical Files Summary

### 修正が必要なファイル（既存）
- `internal/db/db.go` - マイグレーション登録
- `internal/db/sync.go` - **SyncIncremental完全書き換え、syncProjectInternal修正**
- `internal/db/sessions.go` - CreateSessionのシグネチャ変更
- `internal/parser/parser.go` - ListSessionsWithModTimeメソッド追加

### 新規作成ファイル
- `internal/db/migrations/005_file_mod_time.sql` - マイグレーションSQL
- `internal/db/projects.go` - last_scan_time管理メソッド（新規または既存ファイルに追加）

### テストファイル
- `internal/db/db_test.go` - マイグレーションテスト追加
- `internal/db/sync_test.go` - SyncIncrementalテスト追加
- `internal/db/sync_benchmark_test.go` - ベンチマークテスト（新規）
- `internal/parser/parser_test.go` - ListSessionsWithModTimeテスト追加
- `internal/db/projects_test.go` - last_scan_timeメソッドテスト（新規または既存に追加）
- `internal/db/sessions_test.go` - CreateSession修正テスト

---

## まとめ

この実装により、初期スキャン非同期化の効果が最大化されます。

**達成されること**:
- 2回目以降のスキャン時間を約90%短縮（10秒 → 1秒）
- データベースにファイル更新日時を記録
- 更新されたファイルのみをパース
- 後方互換性を維持

**次のステップ**: 実装後、将来的には並列スキャンやファイル削除検出などの拡張も検討可能です。
