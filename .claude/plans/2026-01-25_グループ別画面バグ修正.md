# グループ別画面バグ修正プラン

**作成日**: 2026-01-25
**目的**: グループ別画面での表示不具合とセッション数が0になる問題を修正

---

## 問題の概要

### バグ1: git_rootがないプロジェクトが表示されない
- **現象**: Gitワークツリーを使っていないプロジェクトがグループ一覧に表示されない
- **原因**: `internal/db/grouping.go:22-24` で git_root が NULL/空のプロジェクトをスキップ

### バグ2: グループ統計値が全て0
- **現象**: プロジェクトグループ詳細画面で総セッション数・トークン数・エラー率が全て0
- **原因**: バグ1により `project_group_mappings` テーブルにマッピングが作成されず、`GetGroupStats()` のJOINクエリが該当レコードを返さない

### バグ3: メンバープロジェクトのセッション数が0
- **現象**: グループ詳細画面のメンバープロジェクト一覧でセッション数が全て0
- **原因**: `internal/api/service_db.go:375-379` でエラーハンドリングが不足（エラーログなし）

---

## 修正方針

### ユーザー要件（確認済み）
- ✅ git_rootがないプロジェクトは1つのメンバーを持つ独立グループとして表示
- ✅ データベーススキーマ変更（マイグレーション）を実施

### 実装アプローチ
1. **スキーマ変更**: `project_groups.git_root` を NULL可能に変更
2. **グループ化ロジック修正**: git_rootがないプロジェクトも独立グループとして作成
3. **パフォーマンス改善**: セッション数取得をSQLの COUNT に変更
4. **エラーハンドリング改善**: エラー発生時のログ出力追加

---

## 実装タスク

### Task 1: データベースマイグレーション作成
**ファイル**: `internal/db/migrations/004_nullable_git_root.sql` (新規作成)

**内容**:
```sql
-- project_groups.git_root を NULL可能に変更
-- SQLiteは ALTER TABLE ... MODIFY COLUMN をサポートしないため、テーブル再作成

-- 1. 新しいテーブル構造で作成
CREATE TABLE project_groups_new (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    git_root TEXT,  -- NOT NULL制約を削除
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2. データコピー
INSERT INTO project_groups_new (id, name, git_root, created_at, updated_at)
SELECT id, name, git_root, created_at, updated_at FROM project_groups;

-- 3. 元のテーブル削除
DROP TABLE project_groups;

-- 4. テーブル名変更
ALTER TABLE project_groups_new RENAME TO project_groups;
```

**検証**:
- マイグレーション実行後、`PRAGMA table_info(project_groups)` で git_root の notnull が 0 になっていることを確認

---

### Task 2: CreateProjectGroup() の NULL対応
**ファイル**: `internal/db/project_groups.go`

**変更箇所**: `CreateProjectGroup(name, gitRoot string)` メソッド

**修正内容**:
1. `gitRoot` パラメータを `*string` に変更
2. 空文字列チェックを削除（NULLも許可）
3. INSERTクエリでNULL値を正しく扱う

**修正後のシグネチャ**:
```go
func (db *DB) CreateProjectGroup(name string, gitRoot *string) (int64, error)
```

**テスト**: `project_groups_test.go` に git_root が NULL の場合のテストケースを追加

---

### Task 3: SyncProjectGroups() の修正
**ファイル**: `internal/db/grouping.go`

**変更箇所**: `SyncProjectGroups()` メソッド全体

**修正内容**:
1. git_rootがNULL/空のプロジェクトもグループ化対象に
2. グループ化ロジック:
   - git_rootがある → 同じgit_rootのプロジェクトをグループ化
   - git_rootがない → 各プロジェクトを独立グループとして作成
3. グループ名:
   - git_rootがある → `generateGroupName(gitRoot)` を使用
   - git_rootがない → プロジェクト名を使用

**実装例**:
```go
func (db *DB) SyncProjectGroups() error {
    projects, err := db.ListProjects()
    if err != nil {
        return fmt.Errorf("failed to list projects: %w", err)
    }

    // git_rootごとにプロジェクトをグループ化
    groupMap := make(map[string][]*ProjectRow)
    standaloneProjects := []*ProjectRow{}

    for _, project := range projects {
        if project.GitRoot != nil && *project.GitRoot != "" {
            gitRoot := *project.GitRoot
            groupMap[gitRoot] = append(groupMap[gitRoot], project)
        } else {
            // git_rootがないプロジェクトは独立グループ
            standaloneProjects = append(standaloneProjects, project)
        }
    }

    // git_rootありのグループ処理
    for gitRoot, projectsInGroup := range groupMap {
        // 既存のロジック
        // ...
    }

    // git_rootなしのプロジェクトを独立グループとして作成
    for _, project := range standaloneProjects {
        groupName := project.Name
        group, err := db.GetProjectGroupByName(groupName)
        if err != nil {
            // グループ新規作成
            groupID, err := db.CreateProjectGroup(groupName, nil)
            if err != nil {
                log.Printf("Warning: failed to create standalone group for %s: %v", project.Name, err)
                continue
            }
            group, _ = db.GetProjectGroupByID(groupID)
        }

        // プロジェクトをグループに追加
        err = db.AddProjectToGroup(project.ID, group.ID)
        if err != nil && !strings.Contains(err.Error(), "UNIQUE constraint failed") {
            log.Printf("Warning: failed to add project %s to group: %v", project.Name, err)
        }
    }

    return nil
}
```

**必要な追加メソッド**:
- `GetProjectGroupByName(name string)` - グループ名でグループを取得

**テスト**: `grouping_test.go` の以下のテストを更新:
- `Git Rootがnullのプロジェクトはグループ化されない` → 期待動作を変更（グループが作成される）
- 新規テスト追加: `複数のgit_rootなしプロジェクトが独立グループになる`

---

### Task 4: CountSessions() メソッドの追加
**ファイル**: `internal/db/sessions.go`

**追加メソッド**:
```go
// CountSessions returns the number of sessions for a project
func (db *DB) CountSessions(projectID int64) (int, error) {
    query := `SELECT COUNT(*) FROM sessions WHERE project_id = ?`

    var count int
    err := db.conn.QueryRow(query, projectID).Scan(&count)
    if err != nil {
        return 0, fmt.Errorf("failed to count sessions: %w", err)
    }

    return count, nil
}
```

**テスト**: `sessions_test.go` にテストケースを追加

---

### Task 5: service_db.go のエラーハンドリング改善
**ファイル**: `internal/api/service_db.go`

**変更箇所1**: `ListProjects()` メソッド（60-64行）
```go
// 修正前
sessions, err := s.db.ListSessions(&row.ID, 1000, 0)
sessionCount := 0
if err == nil {
    sessionCount = len(sessions)
}

// 修正後
sessionCount, err := s.db.CountSessions(row.ID)
if err != nil {
    log.Printf("Warning: failed to count sessions for project %s: %v", row.Name, err)
    sessionCount = 0
}
```

**変更箇所2**: `GetProjectGroup()` メソッド（375-379行）
```go
// 修正前
sessions, err := s.db.ListSessions(&row.ID, 1000, 0)
sessionCount := 0
if err == nil {
    sessionCount = len(sessions)
}

// 修正後
sessionCount, err := s.db.CountSessions(row.ID)
if err != nil {
    log.Printf("Warning: failed to count sessions for project %s: %v", row.Name, err)
    sessionCount = 0
}
```

**効果**:
- パフォーマンス向上（SQLで直接COUNT実行）
- エラーログ出力でデバッグが容易に

---

### Task 6: GetProjectGroupByName() メソッドの追加
**ファイル**: `internal/db/project_groups.go`

**追加メソッド**:
```go
// GetProjectGroupByName retrieves a project group by name
func (db *DB) GetProjectGroupByName(name string) (*ProjectGroupRow, error) {
    query := `
        SELECT id, name, git_root, created_at, updated_at
        FROM project_groups
        WHERE name = ?
    `

    var row ProjectGroupRow
    var gitRoot sql.NullString
    var createdAt, updatedAt string

    err := db.conn.QueryRow(query, name).Scan(
        &row.ID,
        &row.Name,
        &gitRoot,
        &createdAt,
        &updatedAt,
    )
    if err != nil {
        return nil, err
    }

    if gitRoot.Valid {
        row.GitRoot = gitRoot.String
    }

    // 日時パース処理（既存メソッドと同様）
    // ...

    return &row, nil
}
```

**テスト**: `project_groups_test.go` にテストケースを追加

---

## 実装の依存関係

```
Task 1 (マイグレーション作成)
  ↓
Task 2 (CreateProjectGroup修正)
  ↓
Task 6 (GetProjectGroupByName追加)
  ↓
Task 3 (SyncProjectGroups修正)
  ↓
Task 4 (CountSessions追加) ─┐
  ↓                          ├→ Task 5 (service_db.go修正)
テスト実行 ─────────────────┘
```

**推奨実装順序**:
1. Task 1 → Task 2 → Task 6 → Task 3（コアロジック）
2. Task 4 → Task 5（パフォーマンス改善）
3. 全タスク完了後に総合テスト

---

## 重要ファイル一覧

### データベース層
- `internal/db/migrations/004_nullable_git_root.sql` (新規)
- `internal/db/project_groups.go` (修正)
- `internal/db/grouping.go` (修正)
- `internal/db/sessions.go` (修正)

### API層
- `internal/api/service_db.go` (修正)

### テスト
- `internal/db/project_groups_test.go` (更新)
- `internal/db/grouping_test.go` (更新)
- `internal/db/sessions_test.go` (更新)

---

## 検証計画

### 1. ユニットテスト
- 全テストが成功することを確認
- 特に `grouping_test.go` の更新テストケースをチェック

### 2. マニュアルテスト

#### テストケース1: git_rootなしプロジェクトのグループ化
1. git_rootがないプロジェクトを作成
2. `SyncProjectGroups()` 実行
3. グループ一覧APIで確認:
   - プロジェクト名のグループが作成されている
   - メンバープロジェクトが1つ
   - git_root が NULL

#### テストケース2: 統計値の表示
1. セッションデータがあるプロジェクトでグループ作成
2. グループ詳細画面で統計値を確認:
   - 総セッション数 > 0
   - 総トークン数 > 0
   - エラー率が正しく計算されている
   - 平均トークン数 > 0

#### テストケース3: メンバープロジェクトのセッション数
1. グループ詳細画面でメンバープロジェクト一覧を確認
2. 各プロジェクトのセッション数が正しく表示される

#### テストケース4: git_rootありとなしの混在
1. git_rootありプロジェクト（ワークツリー）とgit_rootなしプロジェクト（通常）を作成
2. グループ一覧に両方のタイプが表示される
3. それぞれの統計値が正しく計算される

### 3. パフォーマンステスト
- `CountSessions()` 使用後のレスポンス時間を測定
- グループ詳細画面の読み込み速度改善を確認

### 4. エラーハンドリングテスト
- セッション取得でエラーが発生した場合のログ出力を確認
- エラー時もUIが正常に動作することを確認（セッション数=0で表示）

---

## ロールバック計画

マイグレーション失敗時のロールバック手順:

1. データベースファイルのバックアップから復元
   ```bash
   cp ccloganalysis.db.backup ccloganalysis.db
   ```

2. 修正したコードをrevert
   ```bash
   git revert <commit-hash>
   ```

3. サーバー再起動

---

## リスク評価

| リスク | 影響度 | 対策 |
|--------|--------|------|
| マイグレーション失敗 | 高 | 事前バックアップ必須 |
| 既存グループとの名前衝突 | 中 | GetProjectGroupByName() でチェック、衝突時は接尾辞追加 |
| パフォーマンス悪化 | 低 | CountSessions() はインデックス利用で高速 |
| テスト失敗 | 中 | 期待動作の変更を正しく反映 |

---

## 完了条件

- ✅ 全タスクが実装完了
- ✅ 全ユニットテストがパス
- ✅ マニュアルテストケース全てが成功
- ✅ git_rootなしプロジェクトがグループ一覧に表示される
- ✅ グループ統計値が正しく計算される
- ✅ メンバープロジェクトのセッション数が表示される
- ✅ エラーログが適切に出力される
