# トークンダッシュボードドリルダウン機能実装

## 概要

実運用に適したトークン消費分析のダッシュボードに改修する。
ユーザーが全体のトークン消費傾向を把握し、問題のある日・プロジェクト・セッションを段階的にドリルダウンで特定できるようにする。

## ユースケース

```
トップページ（全プロジェクトの日毎トークン消費グラフ）
    ↓ グラフの日付クリック
その日のグループ別トークン消費一覧（パネル表示）
    ↓ グループクリック
グループ詳細ページ（既存の画面遷移を維持）
    ↓ プロジェクトクリック
プロジェクト詳細ページ
    ↓ セッションクリック
セッション詳細（会話内容確認）
```

## 既存の画面遷移（維持する）

現状の `グループ詳細 → プロジェクト詳細 → セッション詳細` の遷移は変更しない。
トップページに全体グラフを追加し、そこからグループ詳細へのドリルダウン導線を追加する形で拡張する。

## 現状の問題点

1. **トップページに全プロジェクトの日毎グラフがない**
   - 現在はプロジェクト一覧テーブルとグループ別グリッドのみ

2. **グループ別タブがデフォルトでない**
   - 「全プロジェクト」タブがデフォルト
   - 実運用ではグループ別で見たい場面が多い

3. **グラフからのドリルダウン機能がない**
   - 現在のグラフはクリックしても何も起こらない

4. **明示的な戻る導線がない**
   - ブラウザの戻るボタンのみ

---

## 実装計画

### Phase 1: トップページに全体サマリーグラフ追加

#### 1.1 バックエンドAPI追加
- [ ] `GET /api/stats/total` - 全プロジェクト合計の統計
- [ ] `GET /api/stats/timeline` - 全プロジェクト合計の日毎タイムライン

**ファイル**: `internal/api/handlers_stats.go` (新規)
**ファイル**: `internal/api/router.go` (ルート追加)

#### 1.2 フロントエンドAPI追加
- [ ] `api.getTotalStats()` - 全体統計取得
- [ ] `api.getTotalTimeline()` - 全体タイムライン取得

**ファイル**: `web/src/api/client.ts`
**ファイル**: `web/src/api/types.ts` (型追加)

#### 1.3 トップページUI改修
- [ ] 全体サマリーカード追加（総トークン、総セッション等）
- [ ] 全体日毎トークン消費グラフ追加
- [ ] グループ別タブをデフォルトに変更
- [ ] タブ順序を「グループ別」「全プロジェクト」に変更

**ファイル**: `web/src/pages/ProjectsPage.tsx`

---

### Phase 2: グラフクリックでドリルダウン

#### 2.1 日付クリックで詳細パネル表示
- [ ] グラフの日付をクリック可能に
- [ ] クリックした日の**グループ別**トークン消費一覧を表示
- [ ] 一覧からグループ詳細にリンク（既存のGroupDetailPageへ遷移）

**新規コンポーネント**: `web/src/components/DailyBreakdownPanel.tsx`

#### 2.2 バックエンドAPI追加
- [ ] `GET /api/stats/daily/{date}` - 特定日のグループ別統計

**ファイル**: `internal/api/handlers_stats.go`

#### 2.3 フロントエンドAPI追加
- [ ] `api.getDailyStats(date)` - 日別詳細取得

**ファイル**: `web/src/api/client.ts`

---

### Phase 3: ナビゲーション改善

#### 3.1 パンくずナビゲーション追加
- [ ] 各ページにパンくずを追加
- [ ] ダッシュボード → グループ → プロジェクト → セッション

**新規コンポーネント**: `web/src/components/Breadcrumb.tsx`

#### 3.2 戻るボタン追加
- [ ] 各詳細ページに「← 戻る」ボタン追加

**ファイル**: `web/src/pages/GroupDetailPage.tsx`
**ファイル**: `web/src/pages/ProjectDetailPage.tsx`
**ファイル**: `web/src/pages/SessionDetailPage.tsx`

---

### Phase 4: グループ詳細ページの強化（オプション）

※ 既存の「グループ詳細 → プロジェクト詳細」の遷移は維持。追加機能として実装。

#### 4.1 グループ詳細ページにセッション一覧タブ追加
- [ ] セッション一覧タブ追加（グループ配下の全セッションを表示）
- [ ] タイムラインチャートクリックでその日のセッション一覧にフィルタ
- [ ] 既存のメンバープロジェクト一覧は維持

**ファイル**: `web/src/pages/GroupDetailPage.tsx`

#### 4.2 バックエンドAPI追加
- [ ] `GET /api/groups/{id}/sessions` - グループ内の全セッション一覧

**ファイル**: `internal/api/handlers_groups.go`

---

## 画面遷移フロー（実装後）

```
┌─────────────────────────────────────────────────────────────┐
│ トップページ (ProjectsPage)                        【新規追加】│
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 全体サマリー: 総トークン | 総セッション | 総グループ        │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 全プロジェクト日毎トークン消費グラフ                        │ │
│ │ [日別] [週別] [月別]                                      │ │
│ │    ▲                                                     │ │
│ │   ╱╲    クリックで                                       │ │
│ │  ╱  ╲   DailyBreakdownPanel表示（グループ別一覧）          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [グループ別](default) | [全プロジェクト]                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ グループカード一覧                                         │ │
│ │ → クリックでGroupDetailPage                               │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
              │
              ▼ （既存の遷移を維持）
┌─────────────────────────────────────────────────────────────┐
│ グループ詳細ページ (GroupDetailPage)               【既存維持】│
│ ← 戻る                                                       │
│ パンくず: ダッシュボード > {グループ名}                         │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ サマリーカード + タイムラインチャート                        │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ メンバープロジェクト一覧                                    │ │
│ │ → クリックでProjectDetailPage                             │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
              │
              ▼ （既存の遷移を維持）
┌─────────────────────────────────────────────────────────────┐
│ プロジェクト詳細ページ (ProjectDetailPage)         【既存維持】│
│ ← 戻る                                                       │
│ パンくず: ダッシュボード > {グループ} > {プロジェクト}          │
│                                                             │
│ [統計・グラフ] | [セッション一覧]                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ タイムラインチャート                                        │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ セッション一覧                                             │ │
│ │ → クリックでSessionDetailPage                             │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
              │
              ▼ （既存の遷移を維持）
┌─────────────────────────────────────────────────────────────┐
│ セッション詳細ページ (SessionDetailPage)           【既存維持】│
│ ← 戻る                                                       │
│ パンくず: ダッシュボード > {グループ} > {プロジェクト} > {ID}   │
│                                                             │
│ トークン使用量詳細                                            │
│ 会話履歴                                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 技術的考慮事項

### パフォーマンス
- 全体タイムラインは重くなる可能性があるため、キャッシュを検討
- 日付範囲を制限（デフォルト30日）

### UX
- グラフクリック時はモーダルではなくスライドパネルを採用（コンテキストを維持）
- ロード中のスケルトン表示

### 既存機能との整合性
- 既存のタイムラインチャートコンポーネントを拡張
- クリックイベントを追加できるよう改修

---

## テスト計画

1. **バックエンドテスト**
   - 新規APIエンドポイントの単体テスト
   - 全体統計の計算ロジックテスト

2. **フロントエンドテスト**
   - グラフクリックイベントの動作確認
   - ナビゲーションフローの確認
   - レスポンシブ表示の確認

3. **統合テスト**
   - ドリルダウン全体フローの動作確認

---

## 優先度

1. **Phase 1** (High): トップページの全体グラフ + グループ別デフォルト - 必須
2. **Phase 2** (High): グラフクリックドリルダウン - コア機能
3. **Phase 3** (Medium): ナビゲーション改善（戻る・パンくず） - UX向上
4. **Phase 4** (Low/Optional): グループ詳細にセッション一覧追加 - 利便性向上

---

## 作成日

2026-01-26
