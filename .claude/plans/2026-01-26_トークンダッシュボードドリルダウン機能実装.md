# トークンダッシュボードドリルダウン機能実装

## 概要

実運用に適したトークン消費分析のダッシュボードに改修する。
ユーザーが全体のトークン消費傾向を把握し、問題のある日・プロジェクト・セッションを段階的にドリルダウンで特定できるようにする。

## ユースケース

```
全プロジェクトの日毎トークン消費グラフ
    ↓ 日付クリック
その日のプロジェクト別トークン消費一覧
    ↓ プロジェクトクリック
プロジェクト詳細（グループ詳細）
    ↓ セッションクリック
セッション詳細（会話内容確認）
```

## 現状の問題点

1. **トップページに全プロジェクトの日毎グラフがない**
   - 現在はプロジェクト一覧テーブルとグループ別グリッドのみ

2. **グループ別タブがデフォルトでない**
   - 「全プロジェクト」タブがデフォルト
   - 実運用ではグループ別で見たい場面が多い

3. **グラフからのドリルダウン機能がない**
   - 現在のグラフはクリックしても何も起こらない

4. **明示的な戻る導線がない**
   - ブラウザの戻るボタンのみ

---

## 実装計画

### Phase 1: トップページに全体サマリーグラフ追加

#### 1.1 バックエンドAPI追加
- [ ] `GET /api/stats/total` - 全プロジェクト合計の統計
- [ ] `GET /api/stats/timeline` - 全プロジェクト合計の日毎タイムライン

**ファイル**: `internal/api/handlers_stats.go` (新規)
**ファイル**: `internal/api/router.go` (ルート追加)

#### 1.2 フロントエンドAPI追加
- [ ] `api.getTotalStats()` - 全体統計取得
- [ ] `api.getTotalTimeline()` - 全体タイムライン取得

**ファイル**: `web/src/api/client.ts`
**ファイル**: `web/src/api/types.ts` (型追加)

#### 1.3 トップページUI改修
- [ ] 全体サマリーカード追加（総トークン、総セッション等）
- [ ] 全体日毎トークン消費グラフ追加
- [ ] グループ別タブをデフォルトに変更
- [ ] タブ順序を「グループ別」「全プロジェクト」に変更

**ファイル**: `web/src/pages/ProjectsPage.tsx`

---

### Phase 2: グラフクリックでドリルダウン

#### 2.1 日付クリックで詳細モーダル/パネル表示
- [ ] グラフの日付をクリック可能に
- [ ] クリックした日のプロジェクト別トークン消費一覧を表示
- [ ] 一覧からプロジェクト/グループ詳細にリンク

**新規コンポーネント**: `web/src/components/DailyBreakdownPanel.tsx`

#### 2.2 バックエンドAPI追加
- [ ] `GET /api/stats/daily/{date}` - 特定日のプロジェクト別統計

**ファイル**: `internal/api/handlers_stats.go`

#### 2.3 フロントエンドAPI追加
- [ ] `api.getDailyStats(date)` - 日別詳細取得

**ファイル**: `web/src/api/client.ts`

---

### Phase 3: ナビゲーション改善

#### 3.1 パンくずナビゲーション追加
- [ ] 各ページにパンくずを追加
- [ ] ダッシュボード → グループ → プロジェクト → セッション

**新規コンポーネント**: `web/src/components/Breadcrumb.tsx`

#### 3.2 戻るボタン追加
- [ ] 各詳細ページに「← 戻る」ボタン追加

**ファイル**: `web/src/pages/GroupDetailPage.tsx`
**ファイル**: `web/src/pages/ProjectDetailPage.tsx`
**ファイル**: `web/src/pages/SessionDetailPage.tsx`

---

### Phase 4: グループ詳細からセッション一覧へのドリルダウン

#### 4.1 グループ詳細ページの改善
- [ ] セッション一覧タブ追加（プロジェクト詳細ページと同様）
- [ ] グラフクリックでその日のセッション一覧にフィルタ

**ファイル**: `web/src/pages/GroupDetailPage.tsx`

#### 4.2 バックエンドAPI追加
- [ ] `GET /api/groups/{id}/sessions` - グループ内の全セッション一覧

**ファイル**: `internal/api/handlers_groups.go`

---

## 画面遷移フロー（実装後）

```
┌─────────────────────────────────────────────────────────────┐
│ トップページ (ProjectsPage)                                   │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 全体サマリー: 総トークン | 総セッション | 総プロジェクト     │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 全プロジェクト日毎トークン消費グラフ                        │ │
│ │ [日別] [週別] [月別]                                      │ │
│ │    ▲                                                     │ │
│ │   ╱╲    クリックで                                       │ │
│ │  ╱  ╲   DailyBreakdownPanel表示                          │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ [グループ別](default) | [全プロジェクト]                      │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ グループカード一覧                                         │ │
│ │ → クリックでGroupDetailPage                               │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│ グループ詳細ページ (GroupDetailPage)                          │
│ ← 戻る                                                       │
│ パンくず: ダッシュボード > {グループ名}                         │
│                                                             │
│ [統計・グラフ] | [セッション一覧]                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ タイムラインチャート                                        │ │
│ │ → クリックでその日のセッション一覧にフィルタ                  │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ メンバープロジェクト一覧                                    │ │
│ │ → クリックでProjectDetailPage                             │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────┐
│ セッション詳細ページ (SessionDetailPage)                       │
│ ← 戻る                                                       │
│ パンくず: ダッシュボード > {グループ} > {プロジェクト} > {ID}   │
│                                                             │
│ トークン使用量詳細                                            │
│ 会話履歴                                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 技術的考慮事項

### パフォーマンス
- 全体タイムラインは重くなる可能性があるため、キャッシュを検討
- 日付範囲を制限（デフォルト30日）

### UX
- グラフクリック時はモーダルではなくスライドパネルを採用（コンテキストを維持）
- ロード中のスケルトン表示

### 既存機能との整合性
- 既存のタイムラインチャートコンポーネントを拡張
- クリックイベントを追加できるよう改修

---

## テスト計画

1. **バックエンドテスト**
   - 新規APIエンドポイントの単体テスト
   - 全体統計の計算ロジックテスト

2. **フロントエンドテスト**
   - グラフクリックイベントの動作確認
   - ナビゲーションフローの確認
   - レスポンシブ表示の確認

3. **統合テスト**
   - ドリルダウン全体フローの動作確認

---

## 優先度

1. **Phase 1** (High): トップページの全体グラフ - ユーザーが最初に見る画面
2. **Phase 2** (High): グラフクリックドリルダウン - コア機能
3. **Phase 3** (Medium): ナビゲーション改善 - UX向上
4. **Phase 4** (Medium): グループセッション一覧 - 利便性向上

---

## 作成日

2026-01-26
