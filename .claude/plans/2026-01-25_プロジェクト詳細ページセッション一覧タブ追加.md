# プロジェクト詳細ページへのセッション一覧タブ追加 - 実装プラン

**日付**: 2026-01-25
**タスク**: mainブランチマージ完了後のフロントエンド実装
**ゴール**: プロジェクト詳細ページで統計とセッション一覧を切り替え表示

---

## 現在の状況

### ✅ 完了済み
- mainブランチからのマージ（競合解決済み）
- `first_user_message`機能の取り込み（`internal/db/sessions.go`、`schema.sql`）
- パフォーマンス改善（757件で2秒→0.5秒未満）

### ⚠️ 対応が必要
1. **テストエラー修正**：`AvgTokens`型の不一致
   - `internal/db/project_stats_test.go:96`
   - `internal/db/group_stats_test.go:92`
2. **マージコミット未完了**
3. **フロントエンド未実装**

---

## 実装ステップ

### Step 1: テストエラー修正 ✅ 優先度: 高

**問題**:
```go
// AvgTokensはfloat64型だが、テストではint型と比較
expectedAvgTokens := (expectedInputTokens + expectedOutputTokens) / 3
if stats.AvgTokens != expectedAvgTokens {  // 型エラー
```

**修正箇所**:

#### 1.1 `internal/db/project_stats_test.go:95-97`
```go
// Before
expectedAvgTokens := (expectedInputTokens + expectedOutputTokens) / 3
if stats.AvgTokens != expectedAvgTokens {

// After
expectedAvgTokens := float64(expectedInputTokens+expectedOutputTokens) / float64(3)
if stats.AvgTokens != expectedAvgTokens {
```

#### 1.2 `internal/db/group_stats_test.go:91-93`
```go
// Before
expectedAvgTokens := (expectedInputTokens + expectedOutputTokens) / 3
if stats.AvgTokens != expectedAvgTokens {

// After
expectedAvgTokens := float64(expectedInputTokens+expectedOutputTokens) / float64(3)
if stats.AvgTokens != expectedAvgTokens {
```

**検証**:
```bash
go test ./internal/db/... -v
# すべてのテストがパスすることを確認
```

---

### Step 2: マージコミット完了

**作業**:
```bash
# テストが全パスしたら
git add internal/db/project_stats_test.go internal/db/group_stats_test.go
git commit
```

**コミットメッセージ**:
```
Merge branch 'main' into project-summary

mainブランチのセッションリストパフォーマンス改善を取り込み、
テストエラーを修正。

主な変更:
- first_user_message機能の取り込み (schema.sql, sessions.go)
- calculateFirstUserMessage()関数の追加
- パフォーマンス改善（757件で0.5秒未満）
- AvgTokens型の不一致を修正 (テスト)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

---

### Step 3: データベース再作成

**目的**: 新しいスキーマ（`first_user_message`カラム含む）でDBを作成し、ログを再読み込み

**作業**:
```bash
# 既存DBをバックアップ（念のため）
cp bin/ccloganalysis.db bin/ccloganalysis.db.backup.$(date +%Y%m%d)

# DB削除
rm bin/ccloganalysis.db

# サーバー起動（新スキーマで自動作成される）
./bin/ccloganalysis

# ログを再読み込みすることで、first_user_messageが自動計算される
```

**メリット**:
- マイグレーション不要
- すべてのセッションで`first_user_message`が正しく計算される
- スキーマの整合性が保証される

---

### Step 4: フロントエンド実装

#### 4.1 SessionListTabコンポーネント作成

**ファイル**: `web/src/components/sessions/SessionListTab.tsx` (新規)

**機能**:
- セッション一覧の表示
- クライアント側ページネーション（20件/ページ）
- セッション詳細へのリンク

**実装内容**:
```tsx
import { useState, useMemo } from 'react'
import { Link } from 'react-router-dom'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import { ChevronLeft, ChevronRight } from 'lucide-react'
import type { SessionSummary } from '@/lib/api/types'

interface SessionListTabProps {
  sessions: SessionSummary[]
  loading: boolean
}

export function SessionListTab({ sessions, loading }: SessionListTabProps) {
  const [currentPage, setCurrentPage] = useState(1)
  const pageSize = 20

  // ページネーション計算
  const totalPages = Math.ceil(sessions.length / pageSize)
  const startIndex = (currentPage - 1) * pageSize
  const endIndex = startIndex + pageSize
  const displayedSessions = useMemo(
    () => sessions.slice(startIndex, endIndex),
    [sessions, startIndex, endIndex]
  )

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      </div>
    )
  }

  if (sessions.length === 0) {
    return (
      <Card>
        <CardContent className="py-12 text-center text-muted-foreground">
          セッションが見つかりません
        </CardContent>
      </Card>
    )
  }

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <CardTitle>
            セッション一覧 ({sessions.length.toLocaleString()}件)
          </CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>セッションID</TableHead>
                <TableHead>ブランチ</TableHead>
                <TableHead>開始時刻</TableHead>
                <TableHead>最初のメッセージ</TableHead>
                <TableHead className="text-right">トークン</TableHead>
                <TableHead className="text-right">エラー</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {displayedSessions.map((session) => (
                <TableRow key={session.id}>
                  <TableCell className="font-medium">
                    <Link
                      to={`/projects/${encodeURIComponent(session.projectName)}/sessions/${encodeURIComponent(session.id)}`}
                      className="text-primary hover:underline"
                    >
                      {session.id.substring(0, 8)}...
                    </Link>
                  </TableCell>
                  <TableCell>{session.gitBranch}</TableCell>
                  <TableCell className="text-muted-foreground">
                    {new Date(session.startTime).toLocaleString('ja-JP')}
                  </TableCell>
                  <TableCell className="max-w-md truncate" title={session.firstUserMessage}>
                    {session.firstUserMessage || '-'}
                  </TableCell>
                  <TableCell className="text-right">
                    {session.totalTokens.toLocaleString()}
                  </TableCell>
                  <TableCell className="text-right">
                    {session.errorCount > 0 ? (
                      <span className="text-destructive font-medium">
                        {session.errorCount}
                      </span>
                    ) : (
                      <span className="text-muted-foreground">0</span>
                    )}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      {/* ページネーション */}
      {totalPages > 1 && (
        <div className="flex items-center justify-between">
          <p className="text-sm text-muted-foreground">
            {startIndex + 1} - {Math.min(endIndex, sessions.length)} / {sessions.length}件
          </p>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setCurrentPage(currentPage - 1)}
              disabled={currentPage === 1}
            >
              <ChevronLeft className="h-4 w-4 mr-1" />
              前へ
            </Button>
            <span className="flex items-center px-4 text-sm text-muted-foreground">
              {currentPage} / {totalPages}
            </span>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setCurrentPage(currentPage + 1)}
              disabled={currentPage === totalPages}
            >
              次へ
              <ChevronRight className="h-4 w-4 ml-1" />
            </Button>
          </div>
        </div>
      )}
    </div>
  )
}
```

#### 4.2 API型定義の更新

**ファイル**: `web/src/lib/api/types.ts`

**確認事項**:
```typescript
// SessionSummaryにfirstUserMessageが含まれているか確認
export interface SessionSummary {
  id: string
  projectName: string
  gitBranch: string
  startTime: string
  endTime: string
  totalTokens: number
  errorCount: number
  firstUserMessage: string  // ← この行が必要
}
```

**もし存在しない場合**: 追加する

#### 4.3 ProjectDetailPageの修正

**ファイル**: `web/src/pages/ProjectDetailPage.tsx`

**変更内容**:

1. **インポート追加**:
```tsx
import { TabsContent } from '@/components/ui/tabs'
import { SessionListTab } from '@/components/sessions/SessionListTab'
import type { SessionSummary } from '@/lib/api/types'
```

2. **状態追加**:
```tsx
const [sessions, setSessions] = useState<SessionSummary[]>([])
const [sessionsLoading, setSessionsLoading] = useState(false)
const [activeTab, setActiveTab] = useState('stats')
```

3. **セッション取得useEffect追加**:
```tsx
useEffect(() => {
  if (!name || activeTab !== 'sessions') return

  const fetchSessions = async () => {
    setSessionsLoading(true)
    try {
      const data = await api.getSessions(name)
      setSessions(data)
    } catch (err) {
      console.error('Failed to fetch sessions:', err)
    } finally {
      setSessionsLoading(false)
    }
  }

  fetchSessions()
}, [name, activeTab])
```

4. **JSX構造変更**:
```tsx
{/* タブUI */}
<Tabs value={activeTab} onValueChange={setActiveTab}>
  <TabsList className="mb-6">
    <TabsTrigger value="stats">統計・グラフ</TabsTrigger>
    <TabsTrigger value="sessions">セッション一覧</TabsTrigger>
  </TabsList>

  {/* 統計タブ */}
  <TabsContent value="stats">
    {/* 既存の統計カード、グラフ、キャッシュ統計を全てここに移動 */}
  </TabsContent>

  {/* セッション一覧タブ */}
  <TabsContent value="sessions">
    <SessionListTab sessions={sessions} loading={sessionsLoading} />
  </TabsContent>
</Tabs>
```

**変更箇所の目安**:
- L51以降の統計表示部分を`<TabsContent value="stats">`で囲む
- 新規に`<TabsContent value="sessions">`を追加

---

### Step 5: テスト・動作確認

#### 5.1 バックエンドテスト
```bash
# すべてのテストがパス
go test ./...
```

#### 5.2 フロントエンドビルド
```bash
cd web
npm run build
cd ..
```

#### 5.3 サーバー起動・動作確認
```bash
# サーバー起動
./bin/ccloganalysis

# ブラウザで確認
# http://localhost:8080/projects/{project-name}
```

**確認項目**:
- [ ] タブ切り替えが動作する
- [ ] 統計タブで既存の統計・グラフが表示される
- [ ] セッション一覧タブでセッションが表示される
- [ ] ページネーションが動作する（20件/ページ）
- [ ] セッションIDクリックでセッション詳細に遷移
- [ ] `firstUserMessage`が表示される
- [ ] 大量セッション（757件など）でも0.5秒未満で表示

---

### Step 6: コミット

**コミットメッセージ**:
```
feat: プロジェクト詳細ページにセッション一覧タブを追加

プロジェクト詳細ページにタブUIを導入し、統計とセッション一覧を
同じページで切り替え表示できるようにした。

変更内容:
- SessionListTabコンポーネント新規作成
  - セッション一覧表示
  - クライアント側ページネーション（20件/ページ）
- ProjectDetailPageにタブUI追加
  - 統計・グラフタブ
  - セッション一覧タブ
- firstUserMessage表示対応

パフォーマンス:
- mainブランチのパフォーマンス改善により、757件で0.5秒未満
- クライアント側ページネーションで快適な閲覧

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

---

## Critical Files

### 修正ファイル
1. **`internal/db/project_stats_test.go`** - AvgTokens型修正
2. **`internal/db/group_stats_test.go`** - AvgTokens型修正
3. **`web/src/pages/ProjectDetailPage.tsx`** - タブUI追加
4. **`web/src/lib/api/types.ts`** - firstUserMessage確認

### 新規ファイル
5. **`web/src/components/sessions/SessionListTab.tsx`** - セッション一覧コンポーネント

---

## エッジケース処理

| ケース | 処理 |
|--------|------|
| セッション0件 | 「セッションが見つかりません」表示 |
| 1ページのみ | ページネーション非表示 |
| ローディング中 | スピナー表示 |
| `firstUserMessage`が空 | ハイフン`-`表示 |
| 長いメッセージ | CSS `truncate`で省略、`title`属性でフル表示 |

---

## パフォーマンス考慮

### クライアント側ページネーション
- **初期ロード**: 全セッションを一度に取得
- **メモリ**: 757件 × 約200バイト = 約150KB（許容範囲）
- **ページ切り替え**: 即座（計算のみ）
- **mainの改善効果**: 0.5秒未満で全件取得可能

### 将来の改善案（1000件以上になったら）
- サーバー側ページネーション
- API: `/api/sessions?project=xxx&limit=20&offset=0`

---

## 検証方法

### ユニットテスト
```bash
go test ./internal/db/... -v -run TestProjectStats
go test ./internal/db/... -v -run TestGroupStats
```

### 統合テスト
```bash
# サーバー起動
./bin/ccloganalysis

# ブラウザで確認（voxmentプロジェクト: 757件）
open http://localhost:8080/projects/-Users-{username}-Documents-GitHub-voxment

# タブ切り替え、ページネーション、リンク遷移を確認
```

### パフォーマンステスト
- 757件のセッションで表示速度が0.5秒未満
- ページ切り替えが即座に反応
- タブ切り替えが瞬時

---

## 期待される結果

### ユーザー体験
- プロジェクト詳細ページで統計とセッション一覧を簡単に切り替え
- 統計タブ: プロジェクト全体の傾向把握
- セッション一覧タブ: 個別セッションの詳細確認
- ページネーションで見やすい20件/ページ表示

### 保守性
- SessionsPageの実装パターンを踏襲
- コンポーネント分割で責務明確
- mainブランチのパフォーマンス改善を活用

---

## 参考資料

- WIPドキュメント: `docs/WIP/2026-01-25_session-list-tab.md`
- 既存プラン: `.claude/plans/shiny-jingling-beaver.md`
- SessionsPage実装: `web/src/pages/SessionsPage.tsx`
- mainブランチコミット: `46945da feat: セッションリストパフォーマンス改善`
