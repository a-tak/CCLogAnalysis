# Windows + Mac向けバイナリパッケージング準備

**作成日**: 2026-01-25
**対象**: Windows (amd64) + Mac (Intel amd64 + Apple Silicon arm64)
**配布方法**: GitHub Releases（GoReleaser使用）

---

## 📋 概要

このプランでは、CCLogAnalysisをWindows + Mac向けにクロスプラットフォームでビルド・配布できるようにします。

### 目標

- ✅ Windows (amd64) 用バイナリの自動生成
- ✅ Mac Intel (amd64) 用バイナリの自動生成
- ✅ Mac Apple Silicon (arm64) 用バイナリの自動生成
- ✅ GitHub Releasesからのダウンロード提供
- ✅ 1バイナリで動作（Reactフロントエンド埋め込み済み）

---

## 🔑 重要な技術的決定: SQLiteドライバーの変更

### 現状の課題

現在のプロジェクトは `go-sqlite3` を使用していますが、これは **cgo依存** のパッケージです。

**cgoの問題**:
- クロスコンパイルが複雑（各プラットフォームのCコンパイラが必要）
- ビルド時間が長い
- 設定が複雑

### 推奨ソリューション: Pure Go SQLiteへの移行

**ドライバー**: `modernc.org/sqlite`

**採用理由**:

1. **実装コストが極めて低い**
   - 変更箇所: `internal/db/db.go` の8行目のみ
   - database/sqlインターフェース完全互換（他のコード変更不要）

2. **クロスコンパイルがシンプル**
   - CGO_ENABLED=0で完結
   - プラットフォーム別コンパイラ不要

3. **パフォーマンストレードオフは許容範囲**
   - INSERT: 2倍遅い、SELECT: 10%～2倍遅い
   - 本アプリケーションは個人用ログ解析ツール（大規模データ処理なし）
   - データ量: 数百～数千セッション程度
   - **体感できるレベルではない**

4. **保守性向上**
   - 依存関係の削減
   - ビルドプロセスの簡素化

**参考**: [SQLite in Go with and without CGO](https://datastation.multiprocess.io/blog/2022-05-12-sqlite-in-go-with-and-without-cgo.html)

---

## 📁 変更が必要なファイル

### 1. SQLiteドライバー変更

**ファイル**: `internal/db/db.go`

**変更内容**:
```go
// 変更前（8行目）
_ "github.com/mattn/go-sqlite3"

// 変更後
_ "modernc.org/sqlite"
```

### 2. Go依存関係の更新

**ファイル**: `go.mod`

**コマンド**:
```bash
go get modernc.org/sqlite
go mod tidy
```

### 3. GoReleaser設定（新規作成）

**ファイル**: `.goreleaser.yml`

**内容**: クロスプラットフォームビルド設定
- フロントエンド自動ビルド（before hooks）
- Windows/Mac向けビルド設定
- アーカイブ形式の設定（Windows: zip / Mac: tar.gz）
- バージョン情報の埋め込み
- チェックサム生成

### 4. GitHub Actions ワークフロー（新規作成）

**ファイル**: `.github/workflows/release.yml`

**トリガー**: `v*` 形式のタグプッシュ

**処理内容**:
- Go 1.25.6 + Node.js 20のセットアップ
- GoReleaserの実行
- GitHub Releasesへの自動アップロード

### 5. Makefile更新

**追加ターゲット**:
```makefile
# GoReleaserのローカルテスト
release-dry-run:
    goreleaser release --snapshot --clean --skip=publish

# スナップショットビルド
release-snapshot:
    goreleaser build --snapshot --clean
```

### 6. README.md更新

**追加セクション**:
- バイナリダウンロード手順
- 対応プラットフォーム一覧
- インストール・実行方法

---

## 🚀 実装手順

### Phase 1: SQLiteドライバー移行（最優先）

1. **依存関係の更新**
   ```bash
   go get modernc.org/sqlite
   go mod tidy
   ```

2. **インポートパス変更**
   - `internal/db/db.go` の8行目を変更

3. **テスト実行**
   ```bash
   make test
   ```

4. **動作確認**
   ```bash
   make build
   ./bin/ccloganalysis
   # http://localhost:8080 にアクセスして動作確認
   ```

**期待結果**:
- すべてのテストがパス
- アプリケーションが正常に起動
- データベース操作が正常に動作

---

### Phase 2: GoReleaser設定

1. **GoReleaserのインストール**
   ```bash
   brew install goreleaser  # macOS
   ```

2. **`.goreleaser.yml` 作成**
   - フロントエンドビルドのhooks設定
   - ビルドターゲット設定（windows/darwin、amd64/arm64）
   - アーカイブ設定
   - チェンジログ設定

3. **ローカルテスト**
   ```bash
   goreleaser release --snapshot --clean --skip=publish
   ```

**確認ポイント**:
- `dist/` ディレクトリにビルド成果物が生成される
- 以下のバイナリが正しく生成される:
  - `ccloganalysis_windows_amd64.zip`
  - `ccloganalysis_darwin_amd64.tar.gz`
  - `ccloganalysis_darwin_arm64.tar.gz`

---

### Phase 3: GitHub Actions設定

1. **`.github/workflows/release.yml` 作成**
   - タグプッシュトリガーの設定
   - Go + Node.jsのセットアップ
   - GoReleaser実行

2. **テストリリース**
   ```bash
   git tag v0.1.0-test
   git push origin v0.1.0-test
   ```

**確認ポイント**:
- GitHub Actionsのワークフローが実行される
- ビルドが成功する
- GitHub Releasesにリリースが作成される
- すべてのプラットフォーム向けアセットがアップロードされる

---

### Phase 4: ドキュメント更新

1. **README.md更新**
   - バイナリダウンロードセクション追加
   - インストール手順追加

2. **CHANGELOG.md作成**
   ```markdown
   # Changelog

   ## [v0.1.0] - 2026-01-XX

   ### Added
   - Windows/Mac向けバイナリパッケージング対応
   - GoReleaserによる自動リリース

   ### Changed
   - SQLiteドライバーをmodernc.org/sqliteに変更（CGO依存を削除）
   ```

3. **Makefileターゲット追加**
   - `release-dry-run`: ローカルテスト用
   - `release-snapshot`: スナップショットビルド

---

### Phase 5: リリース実施

1. **バージョンタグの作成**
   ```bash
   git tag -a v0.1.0 -m "First binary release"
   git push origin v0.1.0
   ```

2. **リリースの確認**
   - GitHub Releasesページで以下を確認:
     - リリースノートが生成されている
     - 全プラットフォームのバイナリがアップロードされている
     - `checksums.txt` が生成されている

3. **ダウンロードテスト**
   - 各プラットフォームのバイナリをダウンロード
   - 解凍して実行
   - 基本機能の動作確認

---

## ⚠️ リスクと注意点

### 1. SQLiteドライバー移行

**リスク**: パフォーマンス低下

- **影響度**: 低
- **対策**: テストでベンチマークを確認、ユーザーフィードバックに応じて対応

**リスク**: 既存DBファイルとの互換性

- **影響度**: 低
- **理由**: SQLiteデータベースフォーマットは標準仕様で互換性あり
- **対策**: 移行前後でテストデータベースを使って検証

### 2. GoReleaser設定

**リスク**: before hooksでフロントエンドビルドが失敗

- **影響度**: 中
- **対策**: ローカルで事前検証、Node.jsバージョンを固定

**リスク**: バイナリサイズが大きい

- **影響度**: 低
- **対策**: ldflagsで `-s -w` 指定（デバッグ情報削除）

### 3. GitHub Actions

**リスク**: ビルド時間がタイムアウト

- **影響度**: 低
- **理由**: Pure Goなのでビルドは高速（数分程度）

---

## ✅ 検証方法

### ローカルテスト

#### 1. SQLiteドライバー移行後

```bash
# 全テスト実行
make test

# アプリケーション起動
make build
./bin/ccloganalysis

# ブラウザで http://localhost:8080 にアクセス
# - プロジェクト一覧の表示
# - セッション一覧の表示
# - セッション詳細の表示
# - グラフの描画
```

#### 2. GoReleaserテスト

```bash
# スナップショットビルド
goreleaser build --snapshot --clean

# 生成されたバイナリの動作確認
./dist/ccloganalysis_darwin_arm64/ccloganalysis
```

### リリース前チェックリスト

- [ ] Windows amd64バイナリが起動する
- [ ] Mac Intel (amd64)バイナリが起動する
- [ ] Mac Apple Silicon (arm64)バイナリが起動する
- [ ] フロントエンドが正しく表示される
- [ ] データベース操作が正常に動作する
- [ ] チェックサムファイルの検証が通る
- [ ] アーカイブファイルサイズが妥当（目安: 20-50MB）

---

## 📊 期待される成果

- Windows + Mac向けのバイナリが自動生成される
- GitHub Releasesから簡単にダウンロード可能
- 1バイナリで動作（フロントエンド埋め込み済み）
- cgo依存なしでメンテナンス性向上
- クロスコンパイルがシンプルで高速

---

## 📚 参考資料

- [modernc.org/sqlite vs go-sqlite3 Performance Comparison](https://datastation.multiprocess.io/blog/2022-05-12-sqlite-in-go-with-and-without-cgo.html)
- [GoReleaser - CGO Documentation](https://goreleaser.com/limitations/cgo/)
- [modernc.org/sqlite Package Documentation](https://pkg.go.dev/modernc.org/sqlite)
- [You don't need CGO to use SQLite in your Go binary](https://hiandrewquinn.github.io/til-site/posts/you-don-t-need-cgo-to-use-sqlite-in-your-go-binary/)
