---
model: claude-haiku-4-5
description: 現在の変更ファイルをコードレビューエージェントで自動レビューします
allowed-tools:
  - Bash
  - Task
  - AskUserQuestion
  - Edit
  - Read
---

# self-review

現在の変更ファイルをコードレビューエージェントで自動レビューします。P0/P1項目を修正後、自動で再レビュー（最大3回）。

## 目的

コミット前に変更ファイルの品質をチェックし、プロジェクト固有のルールやコーディング規約の違反を検出します。

## 実行内容

1. `git status` で変更ファイルを自動検出
2. コードレビューエージェント（`.claude/agents/code-reviewer.md`）を呼び出し
3. 優先度付きレビュー結果を表示
4. P0/P1項目があれば、修正を実施
5. 修正後、自動で再レビュー（最大3回まで繰り返し）
6. P0/P1がゼロになったらコミット可能と通知

## 実行フロー

### ステップ1: 変更ファイルを検出

```bash
git status --short
```

### ステップ2: セルフレビュー実行（初回）

コードレビューエージェントを呼び出してレビューを実施します。

```
Task(
  subagent_type="general-purpose",
  description="コードレビュー実施",
  prompt="`.claude/agents/code-reviewer.md`の指示に従って、以下の変更ファイルをレビューしてください。

## 変更ファイル
<git status --shortの結果を列挙>

優先度付き結果（P0/P1/P2/P3）で報告してください。"
)
```

### ステップ3: レビュー結果の表示

エージェントから返されたレビュー結果を表示します。

```
========================================
📋 セルフレビュー結果
========================================

## P0 (Blocker) - 必須修正
<P0項目の詳細>

## P1 (Critical) - 重要
<P1項目の詳細>

## P2 (Major) - 推奨
<P2項目の詳細>

## P3 (Minor) - 改善提案
<P3項目の詳細>

[📊 サマリー]
- P0 (Blocker): <数>件 🔴
- P1 (Critical): <数>件 ⚠️
- P2 (Major): <数>件 ℹ️
- P3 (Minor): <数>件 💡

[✅ 良い点]
<良い点のリスト>
```

### ステップ4: P0/P1項目があれば修正を実施

P0/P1項目が検出された場合、以下の処理を実施：

1. **AskUserQuestion でどの項目を修正するか確認**

```
AskUserQuestion(
  questions: [{
    question: "以下のP0/P1項目を修正しますか？",
    header: "修正対象",
    multiSelect: true,
    options: [
      { label: "P0 #1: 個人情報漏洩", description: "..." },
      { label: "P1 #2: エラーハンドリング欠如", description: "..." },
      ...
    ]
  }]
)
```

2. **選択された項目の修正を実施**

ユーザーが選択した項目を Edit ツールで修正します。

3. **テスト実行**

```bash
make test
```

テストが失敗した場合は、修正を取り消してユーザーに報告します。

### ステップ5: 修正後に再レビュー（自動）

修正後、再度 git status で変更ファイルを検出し、ステップ2のコードレビューエージェントを再度呼び出します。

**再レビューループ制御:**
- 最大再試行回数: 3回まで
- ループ終了条件: P0/P1項目がゼロになる
- 無限ループ防止: 3回の再レビュー後もP0/P1が残る場合は、残課題を報告してユーザーに判断を委ねる

### ステップ6: 最終判定

- **P0/P1がゼロ**: コミット可能と通知
- **最大再試行回数到達**: 残課題を報告してユーザーに判断を委ねる
- **P2/P3のみの場合**: コミット可能と通知（余裕があれば修正を推奨）
- **問題なしの場合**: 品質良好と通知

## 出力例

### P0/P1がゼロの場合

```
========================================
✅ セルフレビュー完了
========================================

P0/P1の問題は検出されませんでした。
コミット可能です。

[📊 サマリー]
- P0 (Blocker): 0件
- P1 (Critical): 0件
- P2 (Major): 2件
- P3 (Minor): 3件

💡 P2/P3の改善提案がありますが、必須ではありません。
   余裕があれば対応を検討してください。

次のステップ:
  git add .
  git commit -m "..."
```

### P0/P1が残る場合

```
========================================
⚠️ セルフレビュー: 修正が必要です
========================================

P0/P1項目が検出されました。
修正してから再度 /self-review を実行してください。

[📊 サマリー]
- P0 (Blocker): 1件 🔴
- P1 (Critical): 2件 ⚠️

[💡 優先対応項目]
1. P0 #1: 個人情報漏洩
2. P1 #2: エラーハンドリング欠如
3. P1 #3: テストカバレッジ不足

推奨対処:
1. 指摘項目を修正
2. 修正完了後、再度 /self-review を実行
```

## 推奨される使用タイミング

### ケース1: 新機能実装後

```bash
# 実装完了
make test

# セルフレビュー（P0/P1項目を自動修正→再レビュー）
/self-review

# P0/P1がゼロになったらコミット可能と通知される
git add .
git commit -m "feat: 新機能追加"
```

### ケース2: バグ修正後

```bash
# バグ修正完了
make test

# セルフレビュー（P0/P1項目を自動修正→再レビュー）
/self-review

# P0/P1がゼロになったらコミット可能と通知される
git add .
git commit -m "fix: バグ修正"
```

## 参照ドキュメント

- **[.claude/agents/code-reviewer.md](.claude/agents/code-reviewer.md)**: コードレビューエージェントの詳細
- **[CLAUDE.md](../../CLAUDE.md)**: プロジェクトガイドライン
- **[.claude/rules/general.md](../rules/general.md)**: 一般開発ルール
