---
model: claude-haiku-4-5
name: ready-for-pr
description: PR作成準備（mainマージ・ビルド・テスト・セルフレビュー）
allowed-tools:
  - Bash
  - Read
  - Edit
  - Task
argument-hint: "[--skip-unit-tests]"
---

# ready-for-pr

## Context

**PR作成準備を自動化するスキルです。**

このスキルは、PR作成前の最終チェック（mainブランチマージ、ビルド、テスト、セルフレビュー）を一括実行します。

## スキル実行モデル

このスキルは **動的生成モデル** で実行されます：

- **Claude Agent が SKILL.md の指示を読み取り、bash コマンドを動的生成**
- 静的なスクリプトファイル（`.sh`）は最小限（sync-permissions.sh のみ）
- Agent が実行時に適切なコマンドを組み立てて Bash ツールで実行
- 引数解析ロジックも Agent が SKILL.md の記述に従って生成

**利点:**
- スキル定義（SKILL.md）の更新だけで動作変更可能
- スクリプトファイルのメンテナンス負担が小さい
- Agent が文脈に応じて最適なコマンドを生成

## Your task

PR作成準備を自動的に実行し、すべてのチェックが完了したら完了報告を表示してください。

**重要: すべてのステップを自動的に実行してください。**
- **Step 4.5（コード簡素化）**: 高優先度項目は自動修正、低優先度は提案のみ
- **Step 6（セルフレビュー）**: P0項目は自動修正、大規模なP1項目は次イテレーションで対応
- エラーが発生した場合や未修正の重要項目が残る場合のみ中断してユーザーに報告

### 引数の解析

以下の引数をサポートしています:

- `--skip-unit-tests`: ユニットテスト（Step 5）をスキップします

**引数解析ロジック:**
```bash
SKIP_UNIT_TESTS=false

# 渡された引数を解析
for arg in "$@"; do
  case "$arg" in
    --skip-unit-tests)
      SKIP_UNIT_TESTS=true
      ;;
  esac
done
```

### 処理フロー

以下の7つのステップを順番に実行してください：

#### Step 1: mainブランチマージ

```bash
echo "=========================================="
echo "Step 1: mainブランチマージ"
echo "=========================================="
echo ""

git fetch origin main
git merge origin/main --no-edit
```

**成功時**: Step 2へ進む
**コンフリクト発生時**: 以下の処理を実施
1. コンフリクトファイル一覧を取得（`git diff --name-only --diff-filter=U`）
2. `git merge --abort` でマージを中止
3. エラーメッセージを表示（下記参照）

**エラーメッセージ**:
```
⚠️ mainブランチとのコンフリクトが発生しました

コンフリクトファイル:
<`git diff --name-only --diff-filter=U` の出力（abort前に取得）>

手動で解決してください:
1. git fetch origin main
2. git merge origin/main
3. コンフリクトを手動解決
4. git add <解決済みファイル>
5. git commit
6. 再度 /ready-for-pr を実行
```

---

#### Step 2: 許可コマンドの統合

```bash
echo "=========================================="
echo "Step 2: 許可コマンドの統合"
echo "=========================================="
echo ""

./.claude/skills/ready-for-pr/scripts/sync-permissions.sh || true
echo ""
```

**処理内容**:
- ローカル設定ファイル（`.claude/settings.local.json`）の許可コマンドを共有設定（`.claude/settings.json`）に統合
- 各Worktreeで個別に許可したコマンドを、プロジェクト全体で共有できるようにする
- 失敗してもエラーにせず、警告表示のみで続行（`|| true`）

**成功時**: 統合結果を表示してStep 3へ進む
**ローカル設定なし**: "ローカル設定ファイルが存在しません"と表示してStep 3へ進む
**失敗時**: 警告表示のみでStep 3へ進む（処理を中断しない）

---

#### Step 3: 最終ビルド

```bash
echo "=========================================="
echo "Step 3: 最終ビルド"
echo "=========================================="
echo ""

make build
```

**成功時**: Step 4へ進む
**失敗時**: エラー報告して中断

**エラーメッセージ**:
```
⚠️ ビルド失敗: mainマージ後にビルドエラーが発生しました

エラー詳細:
<ビルドエラーメッセージ>

推奨対処:
1. フロントエンドエラーの場合: cd web && npm run build
2. バックエンドエラーの場合: go build -o bin/ccloganalysis ./cmd/server
3. 修正完了後、再度 /ready-for-pr を実行
```

---

#### Step 4: Linterチェック（ESLint）

```bash
echo "=========================================="
echo "Step 4: Linterチェック（ESLint）"
echo "=========================================="
echo ""

# 変更されたフロントエンドファイルを検出（mainブランチからの全変更）
CHANGED_FRONTEND_FILES=$(git diff --name-only origin/main...HEAD | grep "^web/" || true)

if [ -z "$CHANGED_FRONTEND_FILES" ]; then
  echo "ℹ️ フロントエンドファイルの変更がありません。Linterをスキップします。"
  echo ""
else
  echo "📝 変更されたフロントエンドファイル:"
  echo "$CHANGED_FRONTEND_FILES"
  echo ""

  echo "🔧 ESLintチェック実行中（変更ファイルのみ）..."
  # 変更されたファイルのみをlint（webディレクトリからの相対パスに変換）
  LINT_FILES=$(echo "$CHANGED_FRONTEND_FILES" | sed 's|^web/||')
  if cd web && npx eslint $LINT_FILES; then
    cd ..
    echo "✅ ESLint: 問題なし"
  else
    cd ..
    echo "❌ ESLint: エラー検出"
    echo ""
    echo "推奨対処:"
    echo "1. cd web && npx eslint で変更ファイルを確認"
    echo "2. エラーを修正"
    echo "3. 修正完了後、再度 /ready-for-pr を実行"
    exit 1
  fi
  echo ""
fi
```

**成功時**: Step 4.5へ進む
**失敗時**: エラー報告して中断

---

#### Step 4.5: コード簡素化提案（公式code-simplifierプラグイン）

**目的**: Linterチェック後に、コードの簡素化・明確化を提案

**前提条件**: 公式code-simplifierプラグインがインストールされていること
```bash
claude plugin install code-simplifier
```

**実装方法**: このステップはClaude Agentが動的に実行します。以下の処理を実施してください：

```bash
echo "=========================================="
echo "Step 4.5: コード簡素化提案（公式プラグイン）"
echo "=========================================="
echo ""

# 変更されたファイルを検出（mainブランチからの全変更）
CHANGED_FILES=$(git diff --name-only origin/main...HEAD || true)

if [ -z "$CHANGED_FILES" ]; then
  echo "ℹ️ ファイルの変更がありません。コード簡素化をスキップします。"
  echo ""
else
  echo "📝 変更されたファイル:"
  echo "$CHANGED_FILES"
  echo ""
  echo "🔍 コード簡素化提案を実行中（公式code-simplifierプラグイン）..."
  echo ""
fi
```

**bashコマンド実行後、変更されたファイルがある場合のみ、以下のTaskを呼び出してください：**

**実装形式**: code-simplifierエージェントを呼び出してコード簡素化提案を実行します。

**重要**: bashコマンドで取得した `$CHANGED_FILES` の内容を、プロンプト内に**明示的に含めて**ください。エージェントが自分で`git status`を実行しないようにするためです。

```
Task(
  subagent_type="code-simplifier:code-simplifier",
  description="コード簡素化提案",
  prompt="以下のmainブランチからの変更ファイルについて、コードの簡素化提案を行ってください。

## 変更ファイル（mainブランチからの全変更）
<$CHANGED_FILES の内容をここに列挙>

## 重点観点
- コードの明確化・一貫性・保守性の向上
- 関数分割、ネスト削減、命名改善の具体的提案
- TypeScript/React、Goのベストプラクティスに従った改善提案

## 出力
検出された改善機会と推奨される変更を報告してください。"
)
```

**エージェント呼び出し後の処理:**

code-simplifierエージェントからの提案を分析し、以下の基準で修正を実施：

### 修正基準

**修正実施対象（高優先度）:**
- コード重複の削減（約50行以上の重複）
- 深いネスト（6レベル以上）の解消
- 明らかなバグリスク（未使用変数、誤った条件分岐など）

**修正スキップ対象（低優先度）:**
- アーキテクチャ全体の変更
- オプションパターンなどの大規模リファクタリング
- 軽微なコメント改善

### 修正フロー

1. **提案の分析**
   - 高優先度項目（優先度「高」、推定削減行数50行以上）を抽出

2. **修正実施**（高優先度項目がある場合）
   - Editツールで修正を実施
   - 修正後に`make test`を実行して動作確認
   - テスト失敗時は修正を取り消して警告表示

3. **結果表示**

```bash
echo ""
echo "✅ コード簡素化提案が完了しました（公式code-simplifierプラグイン）"
echo ""
if [ 修正実施した場合 ]; then
  echo "🔧 高優先度項目を修正しました"
  echo "   - 修正項目: <修正した項目のリスト>"
  echo ""
fi
echo "💡 その他の提案内容は次イテレーションで検討してください"
echo "   （低優先度項目はPR作成を阻止しません）"
echo ""
```

**成功時**: Step 5へ進む
**失敗時**: 警告表示のみで継続（PR作成を阻止しない）

**重要な注意事項:**
- 高優先度項目は自動修正を試みるが、テスト失敗時は修正を取り消す
- 低優先度項目は提案のみで、PR作成を阻止しない
- エージェント呼び出しに失敗した場合は、警告表示のみで継続

---

#### Step 5: 最終テスト（ユニットテスト）

**SKIP_UNIT_TESTS が true の場合:**
```bash
echo "=========================================="
echo "Step 5: ユニットテスト"
echo "=========================================="
echo ""
echo "⏭️  ユニットテスト実行をスキップします..."
echo ""
```

**SKIP_UNIT_TESTS が false の場合（デフォルト）:**
```bash
echo "=========================================="
echo "Step 5: ユニットテスト"
echo "=========================================="
echo ""

# ユニットテスト実行
if make test; then
  echo ""
  echo "✅ ユニットテストが成功しました"
  echo ""
else
  echo ""
  echo "⚠️ テスト失敗: mainマージ後にテストが失敗しました"
  echo ""
  echo "推奨対処:"
  echo "1. make test で再確認"
  echo "2. エラーを修正"
  echo "3. 修正完了後、再度 /ready-for-pr を実行"
  exit 1
fi
```

**成功時**: Step 6へ進む
**失敗時**: エラー詳細を表示して中断

---

#### Step 6: セルフレビュー

```bash
echo "=========================================="
echo "Step 6: セルフレビュー"
echo "=========================================="
echo ""
```

この後、以下の処理を実施してください：

### 6-1. コードレビューエージェント呼び出し

変更ファイルを検出してcode-reviewerエージェントを呼び出します：

```
Task(
  subagent_type="code-reviewer",
  description="コードレビュー実施",
  prompt="以下の変更ファイルをレビューしてください。`.claude/rules/`配下のルール、プロジェクトガイドライン（CLAUDE.md）、一般開発ルールに従って、優先度付き結果（P0/P1/P2/P3）で報告してください。

## 変更ファイル（mainブランチからの全変更）
<git diff --name-only origin/main...HEAD の結果を列挙>

## 重点チェック項目
1. テスト駆動開発（TDD）規約への準拠
2. エラーハンドリングの適切性
3. 個人情報の取り扱い（プロジェクトはパブリック公開予定）
4. コードの明確性と保守性
5. テストカバレッジの妥当性"
)
```

### 6-2. レビュー結果の判定

**P0/P1項目なし**: Step 7へ進む

**P0/P1項目あり**: 以下のフローで対応

1. **修正対象を判断**
   - P0項目: すべて修正必須
   - P1項目: 実装工数と影響を考慮して判断
     - 軽微な修正（コメント追加、変数名変更など）: 修正実施
     - 大規模なリファクタリング（関数抽出、アーキテクチャ変更など）: 次イテレーションで対応

2. **修正実施**
   - Editツールで指摘項目を修正
   - 修正後に`make test`を実行して動作確認
   - テスト失敗時は修正を取り消して報告

3. **修正後の判定**
   - 全P0項目を修正完了: Step 7へ進む
   - 未修正のP0/P1項目が残る: エラーで中断

**エラーメッセージ**（未修正のP0/P1項目が残る場合）:
```
⚠️ セルフレビューで問題が検出されました

未修正の項目:
P0 (Blocker): <件数>
P1 (Critical): <件数>

推奨対処:
1. 指摘項目を手動で修正
2. 修正完了後、再度 /ready-for-pr を実行
```

---

#### Step 7: 完了報告

すべてのステップが成功したら、以下のメッセージを表示してください:

```
=========================================="
✅ PR作成準備が完了しました！
=========================================="

チェック完了項目:
- ✅ mainブランチマージ
- ✅ 許可コマンド統合
- ✅ ビルド成功
- ✅ Linterチェック成功（ESLint）
- ✅ コード簡素化提案完了（公式プラグイン）
- ✅ ユニットテスト成功 [or スキップ]
- ✅ セルフレビューP0/P1なし

💡 コード簡素化提案:
   公式プラグインから返される提案を確認して、実装可能な改善があれば対応してください
   （セルフレビューで検出された改善提案であり、PR作成を阻止しません）

次のステップ:
手動でPRを作成してください:
  git push origin <branch-name>
  gh pr create
```

---

### 使用例

#### 全テスト実行（推奨）

```bash
/ready-for-pr
```

#### ユニットテストをスキップ

```bash
/ready-for-pr --skip-unit-tests
```

---

## エラーハンドリング

| エラー | 対処方法 |
|-------|---------|
| mainマージでコンフリクト | `git merge --abort` → 手動解決を指示 |
| ビルド失敗 | エラー詳細表示 → 修正を指示 |
| Linterエラー（ESLint） | エラー詳細表示 → 修正を指示 |
| テスト失敗 | エラー詳細表示 → 修正を指示 |
| セルフレビューP0/P1 | 指摘項目表示 → 修正を指示 |

すべてのエラーで「修正後に `/ready-for-pr` を再実行」を案内してください。

---

## 重要な注意事項

### 1. 繰り返し実行可能

このコマンドはエラー時に中断し、修正後に再実行することを前提としています。

ステップ途中で失敗した場合:
1. エラーメッセージを確認
2. 修正を実施
3. 再度 `/ready-for-pr` を実行
4. 前回成功したステップはスキップせず、すべてのステップを最初から実行

### 2. セルフレビューの統合

セルフレビュー（`/self-review`）スキルを内部で呼び出します。

P0/P1項目が検出された場合は、PR作成準備を中断し、修正を促してください。

### 3. テストスキップオプションの使用

- `--skip-unit-tests`: アプリ本体に影響のない変更時（スキル・ドキュメント修正など）に有効
- スキップ時も他のチェック（ビルド、Linter、セルフレビュー）は実行されます

### 4. Agent の役割

このスキルは動的生成モデルで実行されるため、Agent が SKILL.md の指示に従ってコマンドを生成します。
スクリプトファイルは sync-permissions.sh のみで、他の処理は Agent が動的に実行します。
